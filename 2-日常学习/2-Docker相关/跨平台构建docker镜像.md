- [跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](#跨平台构建-docker-镜像新姿势x86arm-一把梭)
  - [前言](#前言)
  - [跨 CPU 架构编译程序的方法](#跨-cpu-架构编译程序的方法)
  - [构建多平台 Docker 镜像](#构建多平台-docker-镜像)


[参考链接](https://cloud.tencent.com/developer/article/1543689)

# 跨平台构建 Docker 镜像新姿势，x86、arm 一把梭

## 前言
在工作和生活中，我们可能经常需要将某个程序跑在不同的 CPU 架构上，比如让某些不可描述的软件运行在树莓派或嵌入式路由器设备上。特别是 Docker 席卷全球之后，我们可以轻松地在 ARM 设备上通过容器部署各种好玩的应用，而不用在意各种系统的差异性。

不过值得庆幸的是，Docker 19.03 引入了一个新的实验性插件，该插件使得跨平台构建 Docker 镜像比以往更加容易了。在介绍这个新特性之前，我们先来了解一下跨 CPU 架构构建程序的基础知识。

## 跨 CPU 架构编译程序的方法
+ 方法一：直接在目标硬件上编译
+ 方法二：模拟目标硬件
    模拟器除了可以用来玩游戏之外，还可以用来跨 CPU 架构构建程序。最常用的模拟器是开源的 QEMU[1]，QEMU 支持许多常见的 CPU 架构，包括 ARM、Power-PC 和 RISC-V 等。通过模拟一个完整的操作系统，可以创建通用的 ARM 虚拟机，该虚拟机可以引导 Linux，设置开发环境，也可以在虚拟机内编译程序。
+ 方法三：模拟目标硬件的用户空间
    在 Linux 上，QEMU 除了可以模拟完整的操作系统之外，还有另外一种模式叫用户态模式（User mod）。该模式下 QEMU 将通过 binfmt_misc[2] 在 Linux 内核中注册一个二进制转换处理程序，并在程序运行时动态翻译二进制文件，根据需要将系统调用从目标 CPU 架构转换为当前系统的 CPU 架构。最终的效果看起来就像在本地运行目标 CPU 架构的二进制文件。
    通过 QEMU 的用户态模式，我们可以创建轻量级的虚拟机（chroot[3] 或容器），然后在虚拟机系统中编译程序，和本地编译一样简单轻松。后面我们就会看到，跨平台构建 Docker 镜像用的就是这个方法。
+ 方法四：使用交叉编译器
    交叉编译器是专门为在给定的系统平台上运行而设计的编译器，但是可以编译出另一个系统平台的可执行文件。例如，amd64 架构的 Linux 系统上的 C++ 交叉编译器可以编译出运行在 aarch64(64-bit ARM) 架构的嵌入式设备上的可执行文件。再举个真实的例子，安卓设备的 APP 基本上都是通过这种方法来编译的。

## 构建多平台 Docker 镜像
```
docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
```