# 如何对地图进行增量更新

## 1. 地图的存储格式

PostGIS 是一个开源的空间数据库扩展，用于将地理信息数据存储和管理在 PostgreSQL 数据库中。
它为 PostgreSQL 添加了对地理数据类型（如点、线、多边形等）的支持，并提供了一系列用于处理和分析地理数据的函数和操作符。以下是 PostGIS 的详细介绍：

PostGIS 按照 Lane，ROI，Curb，WaittingArea，ROIArea 进行存储，并按照tileid进行存储，每一个tile里面包括lane，boundary，curb，waitzone，signal，roi等，将这些数据存储到postgis数据库内。

## 2. 如何进行增量更新

+ 生成新地图：地图使用 200mx200m的tile进行存储，每一个tile都包含坐标位置的tileid，每一个tile里面包括lane，boundary，curb，waittingarea，roi等，将这些数据存储到postgis数据库内，在制作新地图的时候，会将新地图的tile和旧地图的tile通过修改的GeoDiff进行比较，如果差别很大，就将地图进行更新，并计算新tile的md5码，在所有地图比较完成后
+ 在增量更新时，通过protocol buffer 和 grpc 来实现车端和云端的交流，首先车端会上传本地地图的版本信息，tileid和md5码上传到云端，云端会比较最新的地图版本和目标版本，通过比较获取需要更新的tileid的列表，并将这个列表传个车端，
+ 车端通过多个线程，按照tile上传md5码和版本信息，云端会按照版本信息查询是否存在该数据库，如果有改地图数据库，通过GeoDiff生成需要更新的patch，在通过grpc的流传输进行传输，车端再解析patch并更新版本，否则会将最新的数据库传输到本地进行更新
+ 本地会将接收的数据做MD5校验，验证正确后将地图数据写入本地的数据库
+ 为了方式频繁的查询数据库，设置了Redis缓存，存储最新的地图版本信息，减少数据库查询次数。

## 3. 文件传输方式

流式传输是一种高效的数据传输方式，特别适用于需要处理大量数据或实时数据的场景。以下是流式传输的主要优点：

+ 高效利用资源：流式传输可以边接收边处理数据，无需等待所有数据接收完成，从而减少内存占用和提高处理效率。
+ 实时性：适用于实时数据处理和交互，如实时监控、在线视频等，能够及时获取和处理最新数据。
+ 处理大数据：对于非常大的数据集，流式传输可以避免一次性加载所有数据导致的内存不足问题。
