# 问题1：结合epoll和线程池的实现方式及资源竞争管理

## 回答

在激光雷达诊断模块中，我们采用epoll负责监听多个诊断设备的连接请求和I/O事件，而线程池用于处理具体的诊断任务。具体实现如下：

epoll与线程池分工：

+ epoll：通过epoll_create创建实例，使用epoll_ctl注册监听套接字，并设置边缘触发模式（EPOLLET）。当有新的连接或数据到达时，epoll_wait会返回就绪事件。
+ 线程池：每个就绪事件被封装为任务，投递到线程池的任务队列中，由空闲线程处理。例如，处理UDS请求或DoIP报文解析。

资源竞争管理：

+ 读写锁：对DID/DTC数据的访问，使用shared_lock（读操作）和unique_lock（写操作），确保读可并发、写独占。
+ 原子操作：在固件刷写过程中，通过std::atomic标记当前刷写状态，并配合互斥锁保证同一时间仅一个刷写任务执行。
+ 连接标识管理：以source address作为唯一标识符，通过哈希表管理会话状态，避免不同设备间的数据混淆。
