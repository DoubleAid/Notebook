# 视觉里程计 2

## 主要目标

1. 理解光流法跟踪特征点的原理
2. 理解直接法是如何估计相机位姿的
3. 使用g2o进行直接发的计算

直接法是视觉里程计的另一个主要分支

首先说一下特征点法的几个缺点

+ 特征点的提取和描述子的计算非常耗时。实践中，SIFT目前在CPU上是无法实时计算的，而ORB也需要近20ms的计算。如果整个SLAM以30ms/帧的速度运行，那么要一大半时间都将花在计算特征点上
+ 使用特征点时，忽略了除特征点以外的所有信息。一幅画有几十万像素，特征点只有几百个。只使用特征点丢失了大部分可能有用的图像信息
+ 相机有时会运动到特征缺失的地方，这些地方往往没有明显的纹理信息。例如我们会面对一面百强，一个空荡荡的走廊。这些特征点会明显减少，没有足够的匹配点来计算相机运动

下面是几种解决思路

+ 保留特征点，但只计算关键点，不计算描述子，同时使用光流法（Optical Flow）来跟踪特征点的运动。这样可以避免计算和匹配描述子带来的时间，但光流本身的计算需要一定的时间
+ 只计算关键点，不计算描述子，同时使用直接发（Direct Method）来计算特征点在下一时刻图像中的位置。这样也可以跳过描述子的计算过程，而且直接法的计算更加简单
+ 既不计算关键点，也不计算描述子，而是根据像素灰度的差异，直接计算相机运动

第一种方法仍然使用特征点，只是把匹配描述子替换成光流追踪，估计相机运动时仍使用对极几何，PnP或ICP算法。
后两种会根据图像的像素灰度信息来计算相机运动，他们统称为直接发

在使用特征点法估计相机运动时，我们把特征点看作固定在三维空间的不动点。根据他们在相机中的投影位置。通过最小化重投影误差（Reprojection error）来优化相机运动。在这个过程中，我们需要精确的知道空间点在两个相机中投影后的像素位置，这也是我们要对特征进行匹配或跟踪的原因。

同时我们也知道，计算，匹配特征需要付出大量的计算量。相对的，在直接法中，我们并不需要知道点与点之间的对应关系，而是通过最小化光度误差（Photometric error）来求得他们

直接法是本讲的重点，它克服了特征点法的上述缺点而存在的。直接法根据像素的亮度信息估计相机的运动，可以完全不用计算关键点和描述子，于是，既避免了特征的计算时间，也避免了特征缺失的情况。

只要场景中存在明暗变化（可以是渐变，不形成局部的图像梯度），直接发就能工作。

根据使用像素的数量，直接发分为稀疏，稠密和半稠密。相比于特征点法只能重构稀疏特征点（稀疏地图），直接法还具有恢复稠密或半稠密结构的能力

## 光流（Optical Flow）

直接法是从光流法演变而来，光流描述了像素在图像中的运动，而直接法则附带着一个相机运动模型。为了说明直接发，我们先介绍光流

光流是一种描述像素随时间在图像之间运动的方法。我们假设随着时间的流逝，同一个像素会在图像中运动，而我们希望追踪它的运动过程。

+ 其中，计算部分像素运动的称为稀疏光流 ----> Lucas-Kanade光流，也称为LK光流
+ 计算所有像素的称为稠密光流

在LK光流中，我们认为来自相机的图像是随时间变化的。图像可以看作时间的函数 $I(t)$, 那么在t时刻，位于 $(x,y)$ 处的像素，它的灰度可以写成
$$
I(x,y,t)
$$

由于相机的运动，它的图像坐标将发生变化，我们希望估计这个空间点在其他时刻图像中位置，这里有以下引入光流法的基本假设

1. 灰度不变假设：同一空间点的像素灰度值，在各个图像中是固定不变的
$$
I(x, y, t) = I(x+\Delta x, y + \Delta y, t + \Delta t)
$$

对右边进行泰勒展开，保留一次项
$$
I(x + \Delta x, y + \Delta y, t + \Delta t) = I(x, y, t) + \frac {\partial I} {\partial x}dx + \frac {\partial I} {\partial y}dy + \frac {\partial I} {\partial t}dt
$$

移一下项可得
$$
\frac {\partial I} {\partial x} \frac {dx} {dt} + \frac {\partial I} {\partial y} \frac {dy} {dt} = -\frac {\partial I} {\partial t}
$$

其中dx/dt就是像素在x轴方向的运动速度，dy/dt是y轴上的速度，分别记为u，v，同时 $\frac {\partial I} {\partial x}$ 为该点处图像在x方向上的梯度，另一项就是y方向的梯度，把图像在该点的时间变化量记为$I_t$, 写成矩阵形式
$$
\begin{bmatrix}
    I_x & I_y 
\end{bmatrix}\begin{bmatrix}
    u \\
    v
\end{bmatrix}
 = -I_t
$$

我们想要计算的是像素的运动 u， v，但是该式是带有两个变量的一次方程，我们可以计算出图像随时间变化量$I_t$, 但无法计算该点的两个梯度，需要引入额外的约束来计算 u，v

在LK光流中，我们假设某一窗口内的像素具有相同的运动

假设一个大小为 $w \times w$ 的窗口，它含有 $w^2$ 数量的像素，由于该窗口的像素有相同的运动，因此，我们有$w^2$个方程
$$
\begin{bmatrix}
    I_x &
    I_y
\end{bmatrix}_k\begin{bmatrix}
    u \\
    v
\end{bmatrix} = -I_{tk}, k = 1, 2, ...w^2
$$

连立矩阵可得
$$
\begin{bmatrix}
    [I_x, I_y]_1 \\
    [I_x, I_y]_2 \\
    ... \\
    [I_x, I_y]_{w^2}
\end{bmatrix}
\begin{bmatrix}
    u_2 \\
    v_2
\end{bmatrix} = -\begin{bmatrix}
    I_{t1} \\
    I_{t1} \\
    ... \\
    I_{t1}
\end{bmatrix}
$$

这是一个关于 u，v 的超定线性方程，传统的解法就是求最小二乘解，由于像素梯度仅在局部有效，所以如果一次迭代不够好，那么就多迭代几次。 在SLAM中，LK光流常被用来跟踪角点的运动。

## 直接法 (Direct Method)

接下来，我们来讨论与光流有一定相似性的直接法

参照之前的相机位姿方程
$$
p_1 = \begin{bmatrix}
u \\
v \\
1
\end{bmatrix}_1 = \frac 1 {Z_1} KP \\
 \\
p_2 = \begin{bmatrix}
u \\
v \\
1
\end{bmatrix}_2 = \frac 1 {Z_2} K(RP+t) \\
= \frac 1 {Z_2} K(exp(\zeta \times) P)_{1:3}
$$

其中 Z 是P点在相机坐标系下的深度，也就是BP+t的坐标值

由于 $exp(\zeta \times)$ 只能和齐次坐标相乘。所以我们乘完之后要提取前三个元素。

在特征点法中，我们通过特征点和描述子知道了 p1， p2 的像素位置，可以计算重投影的位置

但在直接法中，由于没有特征匹配，我们不知道那两个点是相对应的。

直接法的思路是根据当前相机的位姿估计值来寻找p2的位置。但若位姿不够好，p2的外观会和p1的有明显的区别。为了减少这个差别，我们优化相机位姿来寻找与p1更相似的p2。这样可以通过解一个优化问题，此时计算的误差不是重投影误差，而是光度误差
$$
e = I_1(p_1) - I_2(p_2)
$$

能够做这种优化的理由，仍然是基于灰度不变假设。在直接法中，我们假设一个空间点在各个视角下成像的灰度是不变的。我们有很多空间点 $P_i$, 那么整个相机位姿估计问题就变成了

$$
min_\zeta J(\zeta) = \sum_{i=1}^Ne_i^Te_i \\

e_i = I_1(p_{1, i}) - I_2(p_{2,i})
$$

根据P的来源，我们将直接法进行了分类

+ P来自于稀疏关键点，我们称之为稀疏直接法。通常我们使用数百个或者上千个关键点，并像LK光流那样，假设它周围的像素是不变的。这样稀疏直接法不必计算描述子，并且只使用数百个像素，因此速度最快，但只能计算稀疏的重构
+ P来自部分像素，只考虑使用带有梯度的像素点，舍弃梯度不明显的地方。这种称为半稠密的直接法，可以重构一个半稠密结构
+ P为所有像素，称为稠密直接法，需要GPU加速，像素梯度不明显的点，在运动估计中不会有太大的贡献，在重构时也难以估计位置，但可以建立完整的地图

直接法的优缺点

+ 可以省去计算特征点、描述子的时间
+ 只要求有像素梯度即可，不需要特征点，直接法可以在特征缺失的场合下使用
+ 可以构建半稠密乃至稠密的地图，这是特征点无法做到的

同样的直接法的缺点也比较明显

+ 非凸性：直接法完全依靠梯度搜索，降低目标函数来计算相机位姿。只有在运动很小时直接法才能成功
+ 单个像素没有区分度，只能以数量代替质量
+ 灰度值不变是很强的假设，相机会自动曝光，他会自动调整图像的整体亮度