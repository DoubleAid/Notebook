# 后端1

## 主要目标

1. 理解后端的概念
2. 理解以EKF为代表的滤波器后端工作原理
3. 理解非线性优化的后端，明白稀疏性是如何利用的
4. 使用g2o和Ceres实际操作后端优化

前端里程计只能给出一个短期的轨迹和地图, 由于不可避免的误差累积，这个地图在长时间内是不准确的。所以在视觉里程计的基础上，还希望构建一个尺度规模更大的优化问题，考虑长时间的最优轨迹和地图

## 概述

1. 由于SLAM特征点众多，观测方程的数量远大于运动方程
2. 没有运动方程时，问题转化成SfM问题
3. 噪音符合高斯分布

根据上面的条件，问题就转变成：存在一些运动数据和观测数据，如何去估计状态量的高斯分布

假设我们作为机器人蒙着眼睛行走，刚开始我们还是可以确定自己的方向和位置，随着移动，越来越不确定自己的位置和方向

+ 虽然我们每一步的长度自己都是可以估计出大概的，但随着时间的增长，我们对自己的位置就越来越不确定，输入受噪音的影响，位置估计的方差越来越大
+ 如果我们看得到周围的场景，就可以不断修订自己步伐的误差

将位姿和路标点所有待估计的变量计作x_k, 那么运动方程就变成了
$$
X_k = {x_k, y_1, y_2, y_3,...,y_m} \\
X_k = f(X_{k-1}, u_k) + w_k \\
z_k = h(X_k) + v_k
$$

如果现在我们希望用过去0到k中的数据来估计现在的状态分布
$$
P(x_k | x_0, u_{1:k}, z_{1:k})
$$

也就是蒙眼走路时知道起始位置，每一步的方向和步长，一个路标点的位置，那么我们就可以估计出当前位置的分布

根据贝叶斯法则我们可以得出

$$
P(x_k | x_0, u_{1:k}, z_{1:k}) \propto P(z_k | x_k)P(x_k | x_{k-1}, u_{1:k-1})
$$

也就是知道当前位置下路标点的观测值，以及上一步的状态分布，就可以估计出当前位置的分布

我们明白第一项是由我们现在的眼睛观测得到，也就是观测方程得出的，第二个是由过去所有的状态估计出来的，也就是运动方程得出的
$$
P(x_k | x_{k-1}, u_{1:k-1}) = P(x_{k-1}) + u_kdx
= \int P(x_k | x_{k-1}, u_k)P(x_{k-1})dx_{k-1}
$$

也就是当前位置的分布是上一步的分布加上当前的运动, 这样我们就只关心k的k-1时刻的情况，

接下来的处理分成了两部分
+ 假设马尔可夫性，简单的一阶马氏性认为k时刻的状态只和k-1的状态有关，与之前的运动无关，这样就得到了以扩展卡尔曼滤波（EKF）为代表的滤波器
+ 另一种方法是考虑k之前的所有状态的关系，也就是讲 $P(x_{k-1})$进一步分解，此刻得到非线性优化为主体的优化框架，目前主流的是非线性优化方法

## 线性系统和卡尔曼滤波

马尔可夫性（Markov Property）是概率论和随机过程中的核心概念，描述了一种“无记忆”特性，即​​未来的状态仅依赖于当前状态，而与过去的历史状态无关​​。

在这个假设下
$$
P(x_k | x_0, u_{1:k}, z_{1:k}) = P(x_k | x_{k-1}, u_k)
$$

由于u_k是有噪音的移动向量，噪音与过去无关，所以k-1时刻的位置和步长无关
于是这个问题就变成了如何从k-1时刻的状态分布推导出k时刻的分布，如果k-1时刻的分布是符合某一个位置的高斯分布，那么，我们只需要更新位置的均值和协方差就可以了

$$
x_k = A_kx_{k-1} + u_k + w_k \\
z_k = C_kx_k + v_k \\
$$
假设噪音符合高斯分布
$$
w_k ～ N(0, Q_k) \\
v_k ～ N(0, R_k)
$$

假设 $x_k$ 和 $z_k$ 都是高斯分布，那么 $x_k$ 的均值和协方差就可以通过 $x_{k-1}$ 的均值Ex
和协方差Dx推导出来
$$
P(x_k | x_{k-1},u_k) = N(A_kE_{后验,k-1} + u_k, A_kD_{后验,k-1}A_k^T + Q_k)
$$
也就是当前位置的高斯分布应该符合以这样的一个高斯分布，我们将协方差简写成 $D_{先验}$，均值写成$E_{先验}$

接下来计算当前位置观测到观测点的高斯分布，因为我们已经知道了当前位置的高斯分布，代入到公式中就可以得到
$$
P(z_k | x_k) = N(C_kE_{先验}, C_kD_{先验}C_k^T + R_k)
$$

那么，当前位置下的分布就可以通过贝叶斯法则计算出来
$$
N(E_{后验}， D_{后验}) = N(C_kE_{先验}, C_kD_{先验}C_k^T + R_k) * N(E_{先验}, D_{先验})
$$

我们求高斯分布的指数部分，也就是$\frac {(x - Ex)^2} {Dx}$

$$
\frac {(x-E_{后验})^T(x-E_{后验})} {D_{后验}} = \frac {(z_k - C_kE_{先验})^T(z_k-C_kE_{先验})} {C_kD_{先验}C_k^T + R_k} + \frac {(x - E_{先验})^T(x_k - E_{先验})} {D_{先验}}
$$

展开后比较一次项和二次项的系数，可以得到
$$
D_{后验}^{-1} = C_k^TR^{-1}C_k + D_{先验}^{-1} \\
取 K = D_{先验}C_k^T(C_k^TD_{先验}C_k + R)^{-1} \\
E_{后验} = E_{先验} + K(z_k - C_kE_{先验}) \\
D_{后验} = (I - K C_k)D_{先验} = D_{先验} - K C_kD_{先验}
$$

## 非线性系统和EKF

首先要澄清一点，SLAM的运动方程和观测方程通常是非线性函数，因此，直接应用卡尔曼滤波器是不合适的。然而，扩展卡尔曼滤波器（EKF）通过线性化非线性函数来近似非线性系统的行为，从而在一定程度上解决了这个问题。

我们希望把卡尔曼滤波的结果拓展到非线性系统中，称为扩展卡尔曼滤波，通胀的做法是在某个点的附近进行泰勒展开，只保留一阶项，然后用线性卡尔曼滤波器来处理这个线性化后的系统

我们将运动方程和观测方程在 $x = E_{后验，k-1}$ 处展开，
$$
x_k = f(E_{后验，k-1}, u_k) + \frac {\partial f}{\partial x_{k-1}} {\mid}_{E_{后验，k-1}}(x_{k-1} - E_{先验,k-1}) + w_k \\
$$

其中 $\frac {\partial f}{\partial x_{k-1}}$ 是运动方程对 $x_{k-1}$ 的雅可比矩阵记为F，$w_k$ 是运动噪声，$u_k$ 是控制输入

同样的观测方程就变成了
$$
z_k = h(E_{先验}) + \frac {\partial h} {\partial x_k} {\mid}_{E_{先验}}(x_k - E_{先验}) + v_k \\
$$

其中 $\frac {\partial h} {\partial x_k}$ 是观测方程对 $x_k$ 的雅可比矩阵记为H，$v_k$ 是观测噪声，$z_k$ 是观测值
那么 $P(x_k | x_{k-1},u_k)$ 就变成了
$$
P(x_k | x_{k-1},u_k) = N(f(E_{后验，k-1}, u_k), FD_{后验,k-1}F^T + Q_k) \\
记 E_{先验} = f(E_{后验，k-1}, u_k) \\
D_{先验} = FD_{后验,k-1}F^T + Q_k \\
P(z_k | x_k) = N()