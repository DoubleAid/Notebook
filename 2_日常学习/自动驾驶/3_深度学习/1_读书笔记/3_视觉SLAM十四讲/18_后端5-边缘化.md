# 边缘化

在滑动窗口优化中，当窗口移动时，旧的变量（如较早的机器人位姿）需要被移除，但它们的约束信息（如里程计和观测）仍需保留，以避免信息丢失。​​边缘化​​通过数学方法将旧变量的影响转移到剩余变量上，保持优化问题的稀疏性和计算效率。

以上一章的例子为例，我们继续讨论边缘化的过程。

## 二维滑动窗口问题描述

机器人在二维平面上移动，窗口大小为5，保留最近的5个位姿 (比如 y4, y5, y6, y7, y8)
当机器人到达y9时，需要移除最旧的位姿 y4， 同时保留 y4 对后续位姿的约束信息

## 边缘化过程

### 构建和边缘化变量相关的约束

假设 y4 与 y5 之间有里程计约束，且在 y5 处观测到 y4。这些约束的联合优化问题可以表示为
$$
\min_{y_4, y_5}(||e_{位姿}(y_4, y_5)||^2 + ||e_{观测}(y_4, y_5)||^2)
$$

我们设 位姿信息为x，y_4 处的位姿信息就是 x_4, y_5 处的位姿就是 x_5。观测信息为 z，y_4 处的观测信息就是 z_4, y_5 处的观测信息就是 z_5。我们将上面的残差函数表示为 f(x, z).

我们将其泰勒展开
$$
f(y + \Delta y) = f(x) + F(x) \Delta x + E(z) \Delta z
$$

其中 F(x) 是f(x, z)对 x 的偏微分，E(z) 是f(x, z)对 z 的偏微分

那么整个函数的雅可比矩阵就变成了 $J = \begin{bmatrix}F & E\end{bmatrix}$

那么 由上面的公式，我们可以得到海森矩阵
$$
H = \begin{bmatrix}
F^TF & F^TE \\
E^TF & E^TE
\end{bmatrix}
$$

这里面的参数就变得非常庞大了，比如 F(x) 是对 x 的偏微分。x又包括 x4和x5， 那么就分为了$F(x) = F(x_4, x_5) = f^,_{x_4}(x_4, x_5, z)，f^,_{x_5}(x_4, x_5, z)$

将对某个值的偏微分记为P，这里整个函数的雅可比矩阵就变成了
$$
J = \begin{bmatrix}F & E\end{bmatrix} = \begin{bmatrix}
P_{x_4} & P_{x_5} & P_{z_4} & P_{z_5}
\end{bmatrix}
$$

那么 海森矩阵就可以表示为

