# 占格栅地图

占栅格地图（Occupancy Grid Map, OGM）是激光 SLAM 中最常用的 2D/3D 环境表示方法，核心原理是将物理空间离散化为规则栅格，通过传感器观测（如激光雷达数据）概率性判断每个栅格的 “占用状态”（障碍物 / 自由空间 / 未知），最终生成对环境的拓扑化描述，适配定位、路径规划等下游任务。

其生成原理可简述为 3 步核心流程，兼顾概率建模与工程实现逻辑：

## 1. 空间离散化：栅格划分

+ 将机器人运动的 2D/3D 环境，按固定分辨率（如 2D 中 0.1m×0.1m、3D 中 0.2m×0.2m×0.2m）划分为均匀的栅格阵列，每个栅格是最小空间单元，唯一对应物理空间中的一个区域。
+ 栅格编号与物理坐标一一映射（如 2D 中栅格 (i,j) 对应物理坐标 (x=i×res, y=j×res)），方便传感器数据与栅格的关联。

## 2. 传感器观测建模：概率更新

+ 核心思想：基于激光雷达的 “测距原理”—— 激光束从传感器出发，沿直线传播，若击中障碍物，則激光终点对应栅格为 “占用”，起点到终点之间的栅格为 “自由”；未击中障碍物（激光测距达到最大量程）则终点及前方栅格为 “未知”。
+ 概率更新模型（避免单次观测噪声影响）：
  + 每个栅格维护一个 “占用概率” P（0≤P≤1），初始值为 0.5（未知）。
  + 利用贝叶斯公式融合多帧观测：
    + 当激光击中某栅格（观测为 “占用”）：P = P_prev × P (观测 | 占用) / 归一化因子，概率向 1 逼近；
    + 当激光穿过某栅格（观测为 “自由”）：P = P_prev × P (观测 | 自由) / 归一化因子，概率向 0 逼近；
  + 工程中常用对数几率（Log-Odds）转换，将乘法运算转为加法，简化计算并避免数值溢出。

## 3. 栅格状态判定：阈值化

+ 经过多帧观测更新后，根据栅格的最终占用概率 P 判定状态：
  + P > 阈值（如 0.7）：判定为 “占用栅格”（障碍物，如墙面、家具）；
  + P <阈值（如 0.3）：判定为 “自由栅格”（可通行空间）；
  + 0.3 ≤ P ≤ 0.7：判定为 “未知栅格”（未被激光覆盖的区域）。
+ 最终生成的二值化 / 概率化栅格地图，直观反映环境的障碍物分布。

## 核心总结

占栅格地图的本质是 **“离散化空间 + 概率性观测融合”**：通过栅格划分将连续环境转为离散单元，利用激光雷达的直线传播特性建模观测，再通过多帧概率更新降低噪声影响，最终生成鲁棒、可解释的环境地图，是连接传感器数据与机器人决策的关键桥梁。

## 举例说明

1. 规定似然概率，也就是传感器的准确性，这是由 传感器型号，测量场景决定的，通常是通过 "实验标定" 或 "经验值" 设定

| 真实状态 \ 观测 | P(z=hit / 占用)（真阳性概率） | P(z=free / 占用)（假阴性概率） |
|----------------|----------------------------------|----------------------------------|
| 栅格确实占用（o = 占用） | 传感器检测到占用的概率（可靠性高） | 传感器漏检占用的概率（可靠性低） |
| 栅格确实自由（o = 自由） | 传感器误判占用的概率（可靠性低） | 传感器检测到自由的概率（可靠性高） |

2. 归一化因子 P(z)：观测的全概率

P(z) 是传感器给出观测 z 的 “总概率”，由 全概率公式 计算 —— 它将 “栅格占用” 和 “栅格自由” 两种情况的概率相加，确保后验概率 P(o|z) 落在 [0,1] 区间（否则概率可能大于 1 或小于 0，无物理意义）。

全概率公式推导：$\($P(z) = P(z|o) \cdot P_{prev}(o) + P(z|\neg o) \cdot P_{prev}(\neg o)$

### 场景 1：传感器观测 z=hit（激光击中该栅格）

已知参数：

+ P_prev(o) = 0.5（历史占用概率）；
+ P(z=hit | o) = 0.9（真阳性概率）；
+ P(z=hit | \neg o) = 0.1（假阳性概率）

计算步骤：

1. 计算归一化因子 P(z=hit)：$P(z=hit) = 0.9 \times 0.5 + 0.1 \times 0.5 = 0.45 + 0.05 = 0.5$
2. 计算后验占用概率 P(o|z=hit)：$P(o|z=hit) = \frac{0.9 \times 0.5}{0.5} = 0.9$→ 结论：观测到 “击中” 后，栅格占用概率从 0.5（未知）提升到 0.9（大概率占用）。

### 场景 2：传感器观测 z=free（激光穿过该栅格）

已知参数：

+ P_prev(o) = 0.9（上一帧后，栅格大概率占用）；
+ P(z=free | o) = 0.1（假阴性概率，漏检占用）；
+ P(z=free | \neg o) = 0.9（真阴性概率，正确检测自由）。

计算步骤：

1. 计算归一化因子 P(z=free)：

    $P(z=free) = 0.1 \times 0.9 + 0.9 \times (1-0.9) = 0.09 + 0.09 = 0.18$

2. 计算后验占用概率 P(o|z=free)：

    $P(o|z=free) = \frac{0.1 \times 0.9}{0.18} = 0.5$

结论：观测到 “自由” 后，栅格占用概率从 0.9（大概率占用）回落至 0.5（未知），符合物理逻辑（一次漏检不足以完全否定之前的占用判定）。
