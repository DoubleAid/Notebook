# ESKF 介绍

我们沿用1 维位移 + 趋势一致的真实场景数据，用和 iEKF 完全对齐的逻辑解释ESKF（误差状态卡尔曼滤波）

核心是把状态拆分为名义状态 + 误差状态，用线性的误差状态方程解决非线性状态（如旋转）的估计问题，这也是 ESKF 和传统 EKF、iEKF 的核心区别。

## 一、 ESKF 的核心思想（先讲本质，再看例子）

ESKF 的核心是 “状态拆分 + 误差线性化 + 误差反馈”，解决传统 EKF 直接对非线性状态（如旋转矩阵、四元数）线性化导致的约束破坏、精度下降问题。

### 状态拆分

把真实状态 x 拆分为两部分：$x = \bar{x} \oplus \delta x$

+ $\bar{x}$：名义状态（非线性流型上的状态，如旋转矩阵、位移），满足物理约束（如旋转矩阵正交性）；
+ $\delta x$：误差状态（欧氏空间的小量，如位移误差、旋转向量误差），线性、无约束；
+ $\oplus$：流型上的群运算（如位移是加法，旋转是矩阵乘法）。

### 误差方程线性化

不对真实状态 x 线性化，而是对误差状态 $\delta x$ 构建线性方程 —— 误差状态是小量，线性化误差极小，这是 ESKF 的核心优势。

误差反馈修正用卡尔曼滤波估计误差状态 $\delta x$，再把 $\delta x$ 反馈到名义状态 $\bar{x}$ 上完成修正，同时重置误差状态为 0，进入下一轮迭代。

### 关键区别

+ 传统 EKF：直接对真实非线性状态线性化；
+ iEKF：对真实状态多次迭代线性化，降低误差；
+ ESKF：对线性的误差状态线性化，从根源上减少非线性误差。

## 二、 场景设定（和 iEKF 完全相同，方便对比）

### 1. 状态定义（ESKF 的核心是 “拆分状态”）

+ 真实状态：$x = s$（机器人位移，非线性约束可忽略，1 维场景简化理解）；
+ 名义状态：$\bar{x}$（我们维护的 “基准状态”）；
+ 误差状态：$\delta x = x - \bar{x}$（真实状态与名义状态的偏差，小量、线性）；
+ 初始值：$\bar{x}_0 = 0$，$\delta x_0 = 0$，误差协方差 $P_{\delta x,0} = 0.1$；
+ 传感器：A（IMU，10Hz，位移增量，过程噪声 Q=0.01）、B（激光，1Hz，绝对位移观测，观测噪声 R=0.1）；
+ 观测方程（弱非线性）：$z = h(x) = x^{1.05}$（和 iEKF 一致）。

### 趋势一致的输入数据（和 iEKF 完全相同）

+ 第一秒， A 累计位移增量 x = 1.04, 观测 为 1.08
+ 第二秒， A 累计位移增量 x = 1.05, 观测 为 1.10

## ESKF 的完整流程（以 t0-t9 时刻为例）

ESKF 的流程分为 “名义状态预测 → 误差状态预测 → 误差状态更新 → 误差反馈修正” 四步，循环执行。

### 步骤 1：名义状态预测（IMU 预积分，无误差）

用 IMU 的高频增量更新名义状态：$\bar{x}^- = \bar{x}_{t-1} + \sum_{i=1}^{10} A_i = 0 + 1.04 = 1.04$

这一步只做状态传播，不考虑误差，保证名义状态满足物理约束（如 3 维场景中旋转矩阵的正交性）。

### 步骤 2：误差状态预测（线性方程，核心）

误差状态的预测方程是线性的，因为误差是小量。对于 1 维位移：

+ 误差状态的预测值：$\delta \hat{x}^- = 0$（默认名义状态预测无偏，误差初始为 0）；
+ 误差协方差的预测：$P_{\delta x}^- = P_{\delta x,t-1} + Q = 0.1 + 0.01 = 0.11$；

3 维场景中：误差状态包括位置误差、旋转向量误差、速度误差、IMU 零偏误差，预测方程是线性的，这是 ESKF 的核心优势。

### 步骤 3：误差状态更新（卡尔曼滤波，线性观测）

一步是 ESKF 的核心 —— 对误差状态构建线性观测模型，用卡尔曼增益更新误差。

1. 计算观测残差（基于名义状态）

    用名义状态预测值 $\bar{x}^-$ 计算观测预测值，再和激光观测值求残差：

    $$r = z - h(\bar{x}^-) = 1.08 - (1.04)^{1.05} ≈ 1.08 - 1.092 = -0.012$$
    
2. 计算观测雅可比（对误差状态线性化）

    观测方程 $h(x)$ 对真实状态 x 的导数为 $H_x = \frac{dh}{dx}=1.05x^{0.05}$，在名义状态 $\bar{x}^-$ 处取值：
    
    $H`_x|_{\bar{x}^-} = 1.05 \times (1.04)^{0.05} ≈ 1.0525$
    
    由于 $x = \bar{x} + \delta x$（1 维加法），观测方程对误差状态 $\delta x$ 的雅可比为：
    
    $H_{\delta x} = H_x|_{\bar{x}^-} \times \frac{\partial x}{\partial \delta x} = 1.0525 \times 1 = 1.0525$
    
    关键：雅可比是对线性的误差状态计算，而非非线性的真实状态，线性化误差极小

3. 计算卡尔曼增益（误差状态专属）

$$
K = \frac{P_{\delta x}^- \cdot H_{\delta x}^T}{H_{\delta x} \cdot P_{\delta x}^- \cdot H_{\delta x}^T + R} = \frac{0.11 \times 1.0525}{1.0525 \times 0.11 \times 1.0525 + 0.1} ≈ 0.508
$$

4. 更新误差状态和协方差

$$
\delta \hat{x}^+ = \delta \hat{x}^- + K \cdot r = 0 + 0.508 \times (-0.012) ≈ -0.0061
$$

$$
P_{\delta x}^+ = (I - K \cdot H_{\delta x}) \cdot P_{\delta x}^- = (1 - 0.508 \times 1.0525) \times 0.11 ≈ 0.053
$$

### 步骤 4：误差反馈修正 + 误差重置

误差反馈：用估计的误差状态修正名义状态，得到最优名义状态：

$\bar{x}^+ = \bar{x}^- + \delta \hat{x}^+ = 1.04 + (-0.0061) = 1.0339$

误差重置：修正完成后，误差状态归零，协方差保留（用于下一轮预测）：

$\delta x = 0, \quad P_{\delta x, t} = P_{\delta x}^+ = 0.053$

### 第 2 轮迭代（t10-t19 时刻）

流程完全相同，输入 A 的累计增量为 1.05，B 的观测值为 1.10：

+ 名义状态预测：$\bar{x}^- = 1.0339 + 1.05 = 2.0839$
+ 误差状态更新后：$\delta \hat{x}^+ ≈ -0.0055$
+ 修正后名义状态：$\bar{x}^+ ≈ 2.0839 - 0.0055 = 2.0784$

