# iEKF 迭代介绍

先明确核心：iEKF（迭代扩展卡尔曼滤波）是 EKF 的 “迭代重线性化” 版本，在同一雷达时刻（B 输出）用 IMU 高频数据（A 输出）做先验预测，再以雷达观测为基准多次迭代修正状态，直到残差收敛，解决非线性观测的线性化误差问题。下面用你给的 A（IMU，10Hz）与 B（雷达帧间位姿，1Hz）数据，分两轮迭代举例，把 iEKF 的 “预测→迭代更新→收敛” 讲透

卡尔曼滤波的一般步骤就是设置自变量，构建自变量的残差，就算均值和雅可比矩阵

## 一维的例子

### 核心假设

1. 状态量： x = s（机器人位移，单位 m），初始状态 $x_0 = 0$，初始协方差 $P_0 = 0.1$（初始不确定性小）。
2. 传感器特性：
    + A (IMU, 10Hz): 输出相对位移增量，带小噪声（均值 0，方差 0.01），反映机器人连续运动趋势；
    + B（激光雷达，1Hz）：输出绝对位移观测值，带观测噪声（均值 0，方差 0.1），作为真值校正基准。
3. 过程噪声 Q = 0.01（IMU 预积分的噪声），观测噪声 R = 0.1（激光观测的噪声）
4. 观测方程（非线性，实际上应该是激光点投影在图像上的位置）：$z=h(x)=x^{1.05}$
5. 迭代终止条件：残差 $|r| < 0.02$ 或迭代次数≥3 次。

### 数据

假设 IMU第一秒累计和是 x = 1.04, 激光雷达观测是 1.08

### 第一次iEKF迭代（对应 t9 时刻，B 观测 $z_1=1.08$）

这是 iEKF 的核心流程，分为预测→迭代更新→收敛三步：

1. 步骤 1：IMU 预积分预测（先验状态）
    + 先验位移：$\hat{x}^- = 1.04$（A 的 10 次增量累计和）；
    + 先验协方差：$P^- = P_0 + Q = 0.1 + 0.01 = 0.11$（预测后不确定性略有增加）。
2. 步骤 2：第 1 轮迭代（在先验点线性化）
    + 计算残差：$r_1 = z_1 - h(\hat{x}^-) = 1.08 - (1.04)^{1.05} ≈ 1.08 - 1.092 = -0.012$；
    + 计算雅可比：￥H_1 = \frac{dh}{dx}\big|_{\hat{x}^-} = 1.05 \cdot x^{0.05}\big|_{1.04} ≈ 1.05 \times 1.0024 = 1.0525$；
    + 卡尔曼增益：$K_1 = \frac{P^- \cdot H_1}{H_1 \cdot P^- \cdot H_1 + R} = \frac{0.11 \times 1.0525}{1.0525 \times 0.11 \times 1.0525 + 0.1} ≈ \frac{0.1158}{0.2277} ≈ 0.508$；
    + 状态更新：$\hat{x}^{(1)} = \hat{x}^- + K_1 \cdot r_1 = 1.04 + 0.508 \times (-0.012) ≈ 1.0339$；
    + 协方差更新：$P^{(1)} = (1 - K_1 \cdot H_1) \cdot P^- = (1 - 0.508 \times 1.0525) \times 0.11 ≈ 0.053$。
3. 步骤 3：第 2 轮迭代（在新状态点重线性化）
    
    此时残差 $|r_1|=0.012 < 0.02$，已满足收敛条件？我们验证一下：
    + 重新计算残差：$r_2 = z_1 - h(\hat{x}^{(1)}) = 1.08 - (1.0339)^{1.05} ≈ 1.08 - 1.085 = -0.005$；
    + 重新计算雅可比：$H_2 = 1.05 \times (1.0339)^{0.05} ≈ 1.05 \times 1.0016 = 1.0517$；
    + 卡尔曼增益：$K_2 = \frac{P^{(1)} \cdot H_2}{H_2 \cdot P^{(1)} \cdot H_2 + R} ≈ \frac{0.053 \times 1.0517}{0.053 \times 1.0517^2 + 0.1} ≈ 0.239$；
    + 状态更新：$\hat{x}^{(2)} = \hat{x}^{(1)} + K_2 \cdot r_2 = 1.0339 + 0.239 \times (-0.005) ≈ 1.0327$；
    + 残差验证：$|r_2|=0.005 < 0.02$，满足收敛条件，停止迭代。
4. 步骤 4：收敛结果
    
    最终优化后位移 $\hat{x}^+ = 1.0327$，协方差 $P^+ = 0.048$（不确定性降低），与激光观测 $z_1=1.08$ 的偏差进一步缩小。