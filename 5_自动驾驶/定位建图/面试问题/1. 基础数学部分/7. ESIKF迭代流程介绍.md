# 误差状态迭代卡尔曼滤波 ESIKF

ESIKF 确实是对误差状态进行迭代，直到误差收敛，但关键是：迭代的是 “误差状态观测模型的线性化过程”，而非误差状态本身。

## ESIKF 的核心流程（1 维场景，对比 ESKF）

我们沿用之前的 1 维位移数据（A 累计预测 $\bar{x}^-=1.04$，B 观测 z=1.08），对比 ESKF 和 ESIKF 的差异：

1. ESKF 的误差更新（无迭代，一次线性化）
    + 步骤 1：基于名义状态 $\bar{x}^-$ 计算残差 $r = z - h(\bar{x}^-) = -0.012$；
    + 步骤 2：计算误差状态的雅可比 $H_{\delta x}=1.0525$（仅计算 1 次）；
    + 步骤 3：计算卡尔曼增益 K，更新误差状态 $\delta\hat{x}^+$，反馈修正名义状态；
    + 特点：一次线性化，结束流程。
2. ESIKF 的误差更新（有迭代，多次重线性化）
    
    核心改进：每次用修正后的名义状态，重新计算残差和雅可比，迭代更新误差状态，直到残差收敛。
    
    + 第 1 轮迭代（和 ESKF 完全相同）
        + 残差 $r_1 = z - h(\bar{x}^-_{(0)}) = -0.012$ $(\bar{x}^-_{(0)}=1.04$ 是初始名义状态）；
        + 雅可比 $H_1 = 1.0525$，增益 $K_1=0.508$；
        + 误差状态更新 $\delta\hat{x}^+_{(1)} = -0.0061$；
        + 用误差修正名义状态：$\bar{x}^-_{(1)} = \bar{x}^-_{(0)} + \delta\hat{x}^+_{(1)} = 1.04 - 0.0061 = 1.0339$。
    + 第 2 轮迭代（关键：重算残差和雅可比）
        + 基于新的名义状态 $\bar{x}^-_{(1)}$ 重算残差：
            $$
            r_2 = z - h(\bar{x}^-_{(1)}) = 1.08 - (1.0339)^{1.05} ≈ -0.005
            $$
        + 基于 $\bar{x}^-_{(1)}$ 重算雅可比：$H_2 = 1.05 \times (1.0339)^{0.05} ≈ 1.0517$；
        + 重算增益 $K_2=0.239$，更新误差状态 $\delta\hat{x}^+_{(2)} = -0.0012$；
        + 修正名义状态：$\bar{x}^-_{(2)} = 1.0339 - 0.0012 = 1.0327$。
    + 收敛判断
        
        残差 $|r_2|=0.005 < 0.02$，停止迭代，最终修正后的名义状态 $\bar{x}^+ = 1.0327$。

## ESIKF 的核心优势

1. 兼顾 ESKF 和 iEKF 的优点

    + 继承 ESKF 的优势：拆分状态，保证名义状态满足物理约束（如 3 维旋转矩阵的正交性），线性化对象是误差状态（线性小量，线性化误差本身就小）；
    + 继承 iEKF 的优势：迭代重线性化，进一步降低线性化误差，提升精度，尤其适合强非线性场景（如高速运动、大姿态变化）。
2. 比 iEKF 更高效
    + iEKF 每次迭代都要重新计算真实状态的雅可比（3 维场景是 15 维状态，计算量大）；
    + ESIKF 迭代的是误差状态的雅可比，且误差状态是小量，雅可比的变化幅度小，计算开销更低。

## 四、 延伸到 SLAM 场景（FAST-LIO 为什么不用 ESIKF？）

FAST-LIO1 用的是 iEKF，而不是 ESIKF，核心原因是：

+ FAST-LIO1 的观测模型是激光点 - 面残差，非线性程度相对可控，iEKF 的迭代线性化已经能满足精度要求；
+ ESIKF 的状态拆分和迭代逻辑，会增加代码的复杂度，对于需要实时性的激光 - IMU 融合系统，iEKF 的 “简单高效” 更具工程优势；
+ 后续的 LIO-SAM 等算法，部分采用了 ESIKF 的思想，在精度和实时性之间做了更好的平衡。