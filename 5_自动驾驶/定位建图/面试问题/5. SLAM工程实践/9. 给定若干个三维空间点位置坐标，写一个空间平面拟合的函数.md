# 给定若干个三维空间点位置坐标，写一个空间平面拟合的函数

## 总结

平面拟合通常有以下几个问题：

+ 最小二乘法 (代数距离)
+ 正交距离回归 （几何距离）
+ 随机抽样一致性（RANSAC）
+ 鲁棒拟合方法（M-估计）
+ 优化库方法 （ceres/g2o）

| 方法 | 原理 | 优点 | 缺点 | 适用场景 |
| ---- | ---- | ---- | ---- | ---- |
| 代数最小二乘 | 最小化代数距离 | 计算快，闭式解 | 对离群点敏感 | 高精度数据，无噪声 |
| 几何最小二乘 | 最小化垂直距离 | 精度高，物理意义明确 | 计算复杂 | 精确测量数据 |
| RANSAC | 随机抽样+一致性检验 | 对离群点鲁棒 | 可能非最优，需调参 | 含大量离群点的数据 |
| M-估计 | 鲁棒损失函数 | 平衡效率和鲁棒性 | 需要迭代求解 | 适度噪声数据 |
| Hough变换 | 参数空间投票 | 能处理多个平面 | 计算和存储开销大 | 多平面分割 |

## 最小二乘法 （代数距离）

+ 方法原理：最小化所有点到平面代数距离的平方和
+ 平面方程：ax + by + cz + d = 0 (约束 $a^2 + b^2 + c^2 = 1$)
+ 求解方法：
  + 对点云进行中心化： $p_i^, = p_i - \overline{p}$
  + 残差就变成了 $e = (ax_i^, + by_i^, + cz_i^,)$
  + $d = -a\overline{x} - b\overline{y} - c\overline{z}$

设 $n = [a, b, c]^T$

$$
A = \begin{bmatrix}
x_1^, & y_1^, & z_1^, \\
x_1^, & y_1^, & z_1^, \\
... & ... & ... \\
x_n^, & y_n^, & z_n^, \\
\end{bmatrix}
$$

所以 目标函数就变成么 $\min_{n}{||An||}^2$ = $n^TA^TAn$

这样就变成了 已知 $A^TA$ 已知，求解n, 就变成了求解M的最小特征值，对应的特征向量就是最优的法向量 n

### 算法步骤总结

1. 计算点云中心: $\overline{x}, \overline{y}, \overline{z}$
2. 中心化坐标: $x_i^, = x_i - \overline{x}$, 同理 y，z 也一样
3. 构建协方差矩阵: $M = \sum{p_i^,p_i^T}$
4. 特征值分解，求解 M 的特征值和特征向量
5. 选择最小特征值对应的特征向量作为法向量 (a, b, c)
6. 计算 $d = -a\overline{x} - b\overline{y} - c\overline{z}$

### 最小二乘法 代码实现

[见9.1 代数最小二乘.cpp](9.1%20代数最小二乘.cpp)

## 最小二乘法 （几何距离）

最小化: $\sum({ax_i + bx_i + cz_i + d})^2$, 其中 $a^2 + b^2 + c^2 = 1$

计算方法和上面一样

## RANSAC

### 算法步骤

1. 随机选择最小样本集 （对于平面拟合，3个点）
2. 用最小样本集拟合模型
3. 统计符合模型的"内点"的数量
4. 重复多次，选择内点最多的模型
5. 用所有内点重新拟合最终模型

### RANSAC 代码实现

[见 9.2 RANSAC.cpp](9.2%20RANSAC.cpp)

## 鲁棒拟合方法 (M-估计)

M-估计 是一种广义的最大似然估计方法，通过使用鲁棒损失函数来减少离群点的影响

与 最小二乘法的区别

+ 普通最小二乘法：使用二次损失函数 $\rho = r^2$
+ M-估计：使用鲁棒损失函数，对大残差给予较小权重

### M-估计数学模型

目标函数

$$
\min_{a, b, c, d} \sum_{i=1}^{n} \rho(\frac{ax_i + by_i + cz_i + d}{\sigma})
$$

其中:

+ $\rho$ 是鲁棒损失函数
+ $r_i = ax_i + by_i + cz_i + d$ 是残差
+ $\sigma$ 是尺度参数（噪音水平）

### 算法步骤 迭代重加权最小二乘

1. 计算当前残差 $r_i^{k}$
2. 计算权重 $w_i^k = \frac {\phi(r_i^k / \sigma)} {r_i^k / \sigma}$, 这里面 $\phi$ 是 $\rho$ 的导数
3. 求解 加权最小二乘问题
4. 更新 $\sigma_k$ 为高权重点的残差MAD估计 (距离中值的均值)
5. 迭代直到 $|\sigma_{k+1} - \sigma_k| / \sigma_k < tolerance$

## 霍夫变换

霍夫变换是一种 投票机制，通过参数空间累加来检测几何形状，对于平面检测

**核心原理**

+ 参数化：将平面用参数表示
+ 投票：每个点对可能的参数组合投票
+ 峰值检测：在参数空间中找到得票最多的参数

