# FAST-LIO 流程

## 关键定位和创新

+ 首次实现激光 - IMU 紧耦合 iEKF 框架，以 “IMU 高频预测 + 激光低频校正” 的闭环，在 100–200Hz IMU 与 10–20Hz 激光的搭配下，实现厘米级精度、25ms 内完成一帧处理（含 1200 + 特征点）。
+ 紧耦合 iEKF：将 IMU 预积分与激光点 - 面残差纳入同一代价函数，多次迭代降低线性化误差，适应剧烈运动。
+ 反向传播去畸变：用 IMU 数据重建激光帧内各点时刻姿态，将点云统一到帧末时刻，消除运动拖影。
+ 高效卡尔曼增益公式：计算量仅依赖状态维度（15 维：位置 / 姿态 / 速度 / IMU 零偏），而非测量维度（千级特征点），大幅降低计算开销。
+ 增量式 k-d 树，支持点云动态增删，近邻搜索速度比传统 k-d 树提升 30%+。

## 详细流程

### 系统初始化（静止 2–3 秒）

状态量：$x=[p,q,v,b_g, b_a]（位置 / 姿态 / 速度 / 陀螺仪零偏 / 加速度计零偏），共 15 维。

初始化内容：用静止 IMU 数据估计重力向量、IMU 零偏与噪声协方差，建立初始协方差矩阵$\mathbf{P}_0$。

### 数据同步（时间戳对齐）

按激光帧时间戳截取相邻帧间的 IMU 数据，确保时间戳严格对齐后入队。

### IMU 预积分与状态预测（前向传播）

预积分：对 IMU 角速度 / 加速度积分，输出相对旋转、速度变化、位移及 IMU 偏差增量，作为 iEKF 先验初值。

状态传播：用预积分结果更新状态与协方差，提供高频运动估计，弥补激光帧率不足。

### 点云反向传播去畸变（核心预处理）

用 IMU 预积分的姿态序列，通过球面线性插值（Slerp）重建激光帧内每个点的时刻位姿，将点云反向投影到帧末时刻，消除运动畸变。

公式：$\mathbf{p}_{corrected} = \Delta\mathbf{R}(t_{end}, t_i) \cdot (\mathbf{p}_{raw} - \mathbf{p}(t_i)) + \mathbf{p}(t_{end})$

### 点云特征提取（强制提取，不可跳过）

曲率计算,扫描线分割：按激光扫描线分组，避免特征集中。

特征筛选：每线提取 20–30 个边缘点（高曲率）与 20–30 个平面点（低曲率），每帧共 400–1000 个有效特征点，用于后续配准。

### IKD-Tree 局部地图构建与数据关联

局部地图：维护滑动窗口内的历史特征点云，用 IKD-Tree 存储，支持动态增删。

数据关联：对当前特征点，搜索局部地图近邻点拟合平面，建立点 - 面对应关系，为残差计算做准备。

### iEKF 迭代优化（核心状态更新）

1. 残差构建：计算当前特征点到局部地图平面的距离残差\(r_i = (\mathbf{p}_i - \mathbf{p}_m)^T \cdot \mathbf{n}_m\)，\(\mathbf{n}_m\)为平面法向量。
2. 迭代更新：
   + 线性化观测模型，计算雅可比H。
   + 用创新公式计算卡尔曼增益K（复杂度O(n^2)，n=15）。
   + 更新状态 $\hat{\mathbf{x}}^+ = \hat{\mathbf{x}}^- + \mathbf{K}\mathbf{r}$与协方差$\mathbf{P}^+$。
   + 重复 3–5 次迭代，直到残差收敛
3. 鲁棒核函数：用 Huber 核抑制外点，提升噪声场景鲁棒性。

### 局部地图更新与状态输出

+ 将去畸变后的当前特征点插入 IKD-Tree，移除窗口外旧点，保持地图轻量化。
+ 发布位姿（位置 / 姿态）、速度、IMU 偏差及局部地图，支持上层建图 / 导航调用。