# 传感器的标定

## <font color="skyblue">一、传感器标定的核心内容</font>

传感器标定是让 SLAM / 融合系统 “感知一致” 的基础，核心是解决 “不同传感器的测量偏差” 和 “空间 / 时间对齐” 问题，具体分为以下 5 类（按车载激光 SLAM+IMU 融合场景重点说明）：

### <font color="YellowGreen">1. 传感器内参标定（核心：修正自身测量误差）</font>

每个传感器的 “出厂参数” 存在偏差，内参标定是确定其真实测量模型，关键针对 3 类核心传感器：

+ <font color="Coral">激光雷达内参：</font>
  + 标定内容：激光线的垂直角度（如 128 线雷达每根线的俯仰角）、水平角分辨率、测距误差修正系数、点云时间延迟（单帧内不同点的时间差）；
  + 作用：消除点云 “畸变”（如高速行驶时单帧点云因旋转产生的错位），保证点云的几何准确性；
  + 常用工具：LidarCalib、Autoware 内置标定工具，或基于平面 / 角点的自动标定算法。
+ <font color="Coral">IMU 内参：</font>
  + 标定内容：
    + 零偏（bias）：静止时 IMU 输出的常值误差（如角速率零偏、线加速度零偏）；
    + 刻度因子（scale）：测量值与真实值的比例偏差（如 IMU 输出角速率 100rad/s，真实为 99rad/s，刻度因子 = 0.99）；
    + 轴间耦合（misalignment）：IMU 三轴不垂直导致的交叉干扰（如 X 轴转动影响 Y 轴测量）；
  + 作用：修正 IMU 原始数据，为预积分提供可靠输入；
  + 常用工具：IMU-TK、GTSAM 的 Calibration 模块，或基于六面法的手动标定（适合实验室场景）。
+ <font color="Coral">相机内参（若有视觉融合）：</font>
  + 标定内容：焦距（fx, fy）、主点坐标（cx, cy）、畸变系数（k1, k2, p1, p2 等，处理径向 / 切向畸变）；
  + 作用：将像素坐标转换为相机坐标系下的 3D 射线方向，保证视觉与激光的融合精度；
  + 常用工具：OpenCV 标定工具箱、Kalibr。

### <font color="YellowGreen">2. 传感器外参标定（核心：空间位置对齐）</font>

解决 “不同传感器安装位置 / 姿态差异”，建立各传感器坐标系之间的转换关系（常用旋转矩阵 R + 平移向量 t 描述），车载场景核心是 3 组外参：

+ <font color="Coral">IMU 与激光雷达外参（最关键）：</font>
  + 标定内容：IMU 坐标系 → 激光雷达坐标系的转换（记为 T_imu2lidar）；
  + 作用：将 IMU 预测的位姿（IMU 系）转换为激光雷达系，保证 IMU 里程计与激光点云配准的一致性（对应你之前代码中的imu2Lidar参数）；
  + 常用方法：手眼标定（Hand-Eye Calibration，如基于 Aruco 标定板的动态标定）、LOAM 类算法的自动外参优化（利用 SLAM 闭环修正外参）。
+ <font color="Coral">激光雷达与相机外参（视觉 - 激光融合）：</font>
  + 标定内容：激光雷达坐标系 → 相机坐标系的转换（T_lidar2cam）；
  + 作用：实现激光点云与相机图像的像素级对齐（如点云投影到图像上做语义分割）；
  + 常用工具：Kalibr、Autoware 的 lidar-camera 标定工具（基于棋盘格或 3D 角点）。
+ <font color="Coral">GPS/RTK 与激光雷达外参（户外定位融合）：</font>
  + 标定内容：GPS 天线相位中心 → 激光雷达坐标系的转换（T_gps2lidar）；
  + 作用：将 GPS 输出的大地坐标（经纬度 + 高程）转换为激光雷达系，用于 SLAM 全局定位修正；
  + 常用方法：基于已知场地的多点测量（如在多个标定桩处记录 GPS 和激光雷达坐标，求解转换关系）。

### <font color="YellowGreen">3. 时间戳标定（核心：消除传感器时间同步误差）</font>

传感器的 “采样时刻” 存在偏差（如 IMU 采样于 1000.0ms，激光雷达采样于 1000.5ms，但系统误判为同一时刻），时间戳标定是确定传感器间的时间偏移（time offset）：

+ 标定内容：如激光雷达时间戳 = IMU 时间戳 + Δt（Δt 为时间偏移，可能是固定值或缓慢变化值）；
+ 作用：为后续时间同步提供 “偏移补偿基准”；
+ 常用方法：基于硬件触发信号的标定（如用同一个 PPS 信号触发所有传感器，测量各传感器的响应延迟）、基于数据相关性的自动标定（如利用 IMU 运动与激光点云运动的一致性，优化求解 Δt）。

### <font color="YellowGreen">4. 测距 / 测量精度标定（补充：提升数据可靠性）</font>

针对传感器的 “测量值与真实值偏差” 的标定：

+ 激光雷达：标定测距误差（如不同距离下的测距偏差，拟合误差修正模型）；
+ 相机：标定曝光时间（用于运动模糊修正）、白平衡（影响视觉特征提取）；
+ GPS/RTK：标定多路径误差（通过遮挡实验或滤波算法修正）。

### <font color="YellowGreen">5. 动态特性标定（进阶：适应高速场景）</font>

针对传感器 “动态响应延迟” 的标定（车载高速场景关键）：

+ 标定内容：如 IMU 的采样延迟（从物理运动发生到传感器输出数据的时间）、激光雷达的帧延迟（从开始扫描到输出完整点云的时间）；
+ 作用：修正高速行驶时的 “运动畸变”（如激光雷达单帧扫描期间车辆移动，导致点云变形）；
+ 常用方法：基于高速运动平台的标定（如在测试场让车辆匀速行驶，通过 IMU 运动反推激光雷达的延迟）。

## <font color="skyblue">二、传感器时间戳同步的实现方案（从易到难，工程优先）</font>

时间同步的核心目标：让不同传感器的 “同一物理事件” 对应到系统时间轴上的同一时刻，避免因时间偏差导致融合失效（如 IMU 预积分用错时间间隔、激光与 IMU 数据不匹配）。

### <font color="YellowGreen">核心原则</font>

+ 统一时间基准：所有传感器的时间戳最终转换为系统时间（如 ROS 的 system time） 或硬件同步时间（如 PPS 时间）；
+ 区分 “静态偏移” 和 “动态延迟”：静态偏移（如固定 Δt）可一次性标定，动态延迟（如激光帧延迟）需实时补偿。

### <font color="YellowGreen">具体实现方案（按工程优先级排序）</font>

#### 1. 硬件同步（最优方案，优先采用）

通过硬件信号触发所有传感器，强制采样时刻一致，几乎无同步误差：

+ 实现方式：
  1. 用PPS（脉冲每秒）信号（如 GPS 模块输出的 1Hz 脉冲）作为同步基准，所有传感器（IMU、激光雷达、相机）设置为 “PPS 触发采样”；
  2. 传感器收到 PPS 脉冲后，立即采集数据，并将 PPS 对应的 UTC 时间作为数据时间戳（如 IMU 在 PPS 脉冲到来时采样，时间戳记为 PPS 对应的秒数 + 传感器内部的微秒计数）；
+ 优势：同步精度最高（微秒级），无软件延迟干扰；
+ 适用场景：车载量产场景（如图达通、华为的激光雷达均支持 PPS 输入），需传感器硬件支持触发功能。

#### 2. 软件同步（无硬件支持时的折中方案）

基于 “时间偏移标定 + 实时补偿”，适合实验室或传感器不支持硬件触发的场景：

+ 步骤 1：先标定静态时间偏移 Δt
  + 方法：用 “运动相关性” 标定（如让车辆缓慢转动，IMU 的角速率积分结果与激光雷达点云的旋转变化对齐，求解 IMU 与激光雷达的时间偏移 Δt）；
  + 工具：Kalibr（支持多传感器时间偏移标定）、自定义脚本（基于互相关分析）。
+ 步骤 2：实时时间戳修正
  + 对传感器原始时间戳进行补偿：如激光雷达原始时间戳为 t_lidar_raw，修正后为 t_lidar = t_lidar_raw + Δt_imu2lidar（Δt_imu2lidar 为 IMU 相对于激光雷达的时间偏移）；
  + 处理动态延迟：激光雷达单帧扫描有延迟（如 100ms），需将帧时间戳修正为 “扫描开始时间”（而非输出时间），可通过传感器手册获取延迟参数，或用 IMU 数据反推。
+ 步骤 3：数据插值（填补时间间隙）
  + 激光雷达帧率低（10Hz），IMU 帧率高（500Hz），需将 IMU 数据插值到激光雷达的采样时刻，用于预积分；
  + 方法：线性插值（适合短时间间隔）、基于 IMU 运动模型的插值（如用角速率积分插值姿态）；

+ 优势：无需硬件改造，实现灵活；
+ 劣势：同步精度中等（毫秒级），受软件延迟影响。

#### 3. 系统级时间同步（基础保障）

确保所有传感器的时间戳基于同一 “系统时间”，避免时间基准不一致：

+ 实现方式：
  + 车载场景：用 GPS/RTK 的 UTC 时间同步车载电脑（如通过 NTP 服务），所有传感器的时间戳转换为 UTC 时间；
  + 室内场景：用电脑的系统时间作为基准，传感器通过 USB/Ethernet 传输数据时，由电脑记录接收时间（需修正传输延迟）；
+ 关键：减少系统时间漂移（如定期用 NTP 校准电脑时间，或用 PPS 信号同步系统时钟）。

#### 4. 数据关联验证（同步正确性检查）

同步后需验证效果，避免同步失败：

+ 验证方法：
  + 运动一致性检查：车辆匀速行驶时，IMU 积分的位移与激光雷达配准的位移应一致（时间同步错误会导致偏差）；
  + 残差检查：SLAM 融合的 IMU 约束残差应在合理范围（同步误差大会导致残差激增）；
+ 工具：ROS 的rqt_bag工具（可视化不同传感器的时间戳分布）、自定义日志分析脚本。

### 工程实践建议（车载 SLAM 场景）

1. 优先采用 “硬件同步（PPS 触发）+ 系统时间校准（NTP）” 方案，同步精度最高，适配量产需求；
2. 若无硬件触发，用 “Kalibr 标定时间偏移 + 线性插值” 方案，同时定期重新标定偏移（避免温度变化导致偏移漂移）；
3. 激光雷达的 “帧延迟” 必须修正：如 128 线雷达单帧扫描时间 50ms，若输出时间戳为扫描结束时间，需减去 50ms 作为扫描开始时间，确保与 IMU 数据对齐；
4. 同步后的数据需存入 ROS Bag 时，保留原始时间戳和修正后的时间戳，便于后续调试。

## 总结

1. 传感器标定核心：内参（修正自身误差）、外参（空间对齐）、时间戳（时间对齐），其中 IMU - 激光雷达的内参 + 外参 + 时间偏移是车载激光 SLAM 的 “三大基础标定”；
2. 时间戳同步优先选硬件同步（PPS），无硬件支持时用软件标定 + 插值，核心是 “统一时间基准 + 补偿静态偏移 + 修正动态延迟”，同步后需通过运动一致性验证效果。
