# 常见的残差和雅可比计算

## <font color="skyblue">数据结构定义</font>

### <font color="YellowGreen">位姿状态</font>

| 状态量 | 时间戳 | 位置 | 姿态(单位四元数) | 速度 | 陀螺仪零偏 | 加速度计零偏 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 变量类型 | double | Vector3d | Quaterniond | Vector3d | Vector3d | Vector3d |

### <font color="YellowGreen">IMU 预积分结果</font>

|||

### <font color="YellowGreen">视觉特征观测 (用于重投影误差)</font>

| 相机ID | 图像平面观测点 | 特征点世界坐标 | 观测信息矩阵（协方差逆）|
| ---- | ---- | ---- | ---- |
| int | Vector2d | Vector3d | Matrix2d |

## <font color="skyblue">相机重投影误差</font>

使用位姿状态，有以下这些核心公式

+ 相机坐标 --> 世界坐标 ：$P_w = RP_c + d$ --> $P_c = q \times (P_w - p)$
+ 相机坐标 --> 图像坐标（透视投影） ： $uv_{pred} = \frac {1} {Z_c} K * P_c$, 其中 $Z_c = P_c.z()$, 相机坐标系下的深度

### <font color="YellowGreen">雅可比推导核心思路</font>

加权残差的雅可比是链式法则的应用：$\frac{\partial \text{weighted\_res}}{\partial \text{优化变量}} = \sqrt{\Omega} \cdot \frac{\partial \text{res}}{\partial \text{优化变量}} = \sqrt{\Omega} \cdot \left( -\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \text{优化变量}} \right)$

（因为 $\text{res} = \mathbf{uv}_{\text{obs}} - \mathbf{uv}_{\text{pred}}$，而 $\mathbf{uv}_{\text{obs}}$ 是常量，导数为 0）

因此，推导可拆为两步：

1. 先求 $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{p}}$ 和 $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{q}}$（预测投影对优化变量的导数）；
2. 再乘以 $-\sqrt{\Omega}$，得到加权残差的雅可比。

### <font color="YellowGreen">第一步：推导</font> $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{p}}$ <font color="YellowGreen">（投影对位置的导数）</font>

#### <font color="Coral">中间导数</font> $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c}$

由透视投影公式 $\mathbf{uv}_{\text{pred}} = \frac{1}{Z_c} \mathbf{K} \cdot \mathbf{P}_c$，展开内参矩阵 $\mathbf{K}$：$\mathbf{K} = \begin{bmatrix} f_x & 0 & c_x \\ 0 & f_y & c_y \\ 0 & 0 & 1 \end{bmatrix}$, （$f_x, f_y$ 为焦距，$c_x, c_y$ 为图像中心）

设 $\mathbf{P}_c = [X_c, Y_c, Z_c]^T$，则预测投影坐标为：

$$
u_{\text{pred}} = \frac{f_x X_c + c_x Z_c}{Z_c} = f_x \frac{X_c}{Z_c} + c_x \\
v_{\text{pred}} = \frac{f_y Y_c + c_y Z_c}{Z_c} = f_y \frac{Y_c}{Z_c} + c_y
$$

对 $\mathbf{P}_c = [X_c, Y_c, Z_c]^T$ 求偏导（链式法则）：

$\frac{\partial u_{\text{pred}}}{\partial X_c} = \frac{f_x}{Z_c}, \quad \frac{\partial u_{\text{pred}}}{\partial Y_c} = 0, \quad \frac{\partial u_{\text{pred}}}{\partial Z_c} = -\frac{f_x X_c}{Z_c^2}$

$\frac{\partial v_{\text{pred}}}{\partial X_c} = 0, \quad \frac{\partial v_{\text{pred}}}{\partial Y_c} = \frac{f_y}{Z_c}, \quad \frac{\partial v_{\text{pred}}}{\partial Z_c} = -\frac{f_y Y_c}{Z_c^2}
$

整理为矩阵形式（维度 2×3）：

$$
\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} = \begin{bmatrix} \frac{f_x}{Z_c} & 0 & -\frac{f_x X_c}{Z_c^2} \\ 0 & \frac{f_y}{Z_c} & -\frac{f_y Y_c}{Z_c^2} \end{bmatrix} = \frac{1}{Z_c} \begin{bmatrix} f_x & 0 & -u_{\text{pred}} + c_x \\ 0 & f_y & -v_{\text{pred}} + c_y \end{bmatrix}
$$

（注：$u_{\text{pred}} - c_x = f_x X_c / Z_c$，代入后可简化，代码中常用前一种形式）

#### <font color="Coral">中间导数：</font> $\frac{\partial \mathbf{P}_c}{\partial \mathbf{p}}$

由 $\mathbf{P}_c = \mathbf{q} \otimes (\mathbf{P}_w - \mathbf{p})$，令 $\Delta \mathbf{P} = \mathbf{P}_w - \mathbf{p}$，则 $\mathbf{P}_c = \mathbf{q} \cdot \Delta \mathbf{P}$（四元数旋转向量，可简化为旋转矩阵乘法）。

四元数 $\mathbf{q}$ 对应的旋转矩阵为 $\mathbf{R} = \mathbf{q}.toRotationMatrix()$，因此：$\mathbf{P}_c = \mathbf{R} \cdot \Delta \mathbf{P} = \mathbf{R} \cdot (\mathbf{P}_w - \mathbf{p})$ 

对 $\mathbf{p}$ 求导（$\mathbf{R}$ 与 $\mathbf{p}$ 无关，导数为 0）：

$$
\frac{\partial \mathbf{P}_c}{\partial \mathbf{p}} = -\mathbf{R}
$$

（维度：3×3，因为 $\mathbf{P}_c$ 是 3×1，$\mathbf{p}$ 是 3×1）

#### <font color="Coral">最终：</font> $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{p}}$

由链式法则：$\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{p}} = \frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} \cdot \frac{\partial \mathbf{P}_c}{\partial \mathbf{p}}$

代入之前的结果：$\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{p}} = -\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} \cdot \mathbf{R}$

#### <font color="Coral">加权残差的雅可比</font>

$$
\frac{\partial \text{weighted\_res}}{\partial \mathbf{p}} = \sqrt{\Omega} \cdot \left( -\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{p}} \right) = \sqrt{\Omega} \cdot \frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} \cdot \mathbf{R}
$$

### 第二步：推导 $\frac{\partial \text{weighted\_res}}{\partial \mathbf{q}}$（投影对姿态的导数）

#### 1. 核心难点：四元数的导数

四元数是 4 维变量，但受 “单位长度约束”（$w^2 + x^2 + y^2 + z^2 = 1$），其导数需要用 “虚部向量” 或 “旋转导数” 简化。

工程中常用**右乘扰动模型（更易推导）**：

对单位四元数 $\mathbf{q}$ 施加微小扰动 $\delta \mathbf{q} = [1, \frac{1}{2}\delta \boldsymbol{\theta}^T]^T$（$\delta \boldsymbol{\theta}$ 是 3 维旋转扰动向量，微小量），则扰动后的四元数为：

$$
\mathbf{q}' = \mathbf{q} \otimes \delta \mathbf{q}
$$

对应的旋转矩阵扰动为：$\mathbf{R}' = \mathbf{R} \cdot (\mathbf{I} + [\delta \boldsymbol{\theta}]_{\times})$（$[\cdot]_{\times}$ 表示向量的反对称矩阵，$\mathbf{I}$ 是 3×3 单位矩阵）

#### 2. 中间导数：$\frac{\partial \mathbf{P}_c}{\partial \delta \boldsymbol{\theta}}$

由 $\mathbf{P}_c = \mathbf{R} \cdot \Delta \mathbf{P}$（$\Delta \mathbf{P} = \mathbf{P}_w - \mathbf{p}$），扰动后：

$$
\mathbf{P}_c' = \mathbf{R}' \cdot \Delta \mathbf{P} = \mathbf{R} \cdot (\mathbf{I} + [\delta \boldsymbol{\theta}]_{\times}) \cdot \Delta \mathbf{P} = \mathbf{P}_c + \mathbf{R} \cdot [\delta \boldsymbol{\theta}]_{\times} \cdot \Delta \mathbf{P}
$$

对 $\delta \boldsymbol{\theta}$ 求导（微小扰动下，高阶小项忽略）：$\frac{\partial \mathbf{P}_c}{\partial \delta \boldsymbol{\theta}} = \mathbf{R} \cdot [\Delta \mathbf{P}]_{\times}$

（注：反对称矩阵满足 $[\mathbf{a}]_{\times} \cdot \mathbf{b} = -[\mathbf{b}]_{\times} \cdot \mathbf{a}$，可简化为 $-[\mathbf{R} \cdot \Delta \mathbf{P}]_{\times} \cdot \mathbf{R}$，但工程中常用前一种形式）

#### 3. 中间导数：$\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \delta \boldsymbol{\theta}}$

由链式法则：$\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \delta \boldsymbol{\theta}} = \frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} \cdot \frac{\partial \mathbf{P}_c}{\partial \delta \boldsymbol{\theta}} = \frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} \cdot \mathbf{R} \cdot [\Delta \mathbf{P}]_{\times}$

#### 4. 四元数导数与旋转扰动的映射

我们需要的是 $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{q}}$（4 维导数），而上面得到的是 $\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \delta \boldsymbol{\theta}}$（3 维导数）。结合四元数扰动模型 

$$
\delta \mathbf{q} = [1, \frac{1}{2}\delta \boldsymbol{\theta}^T]^T
$$

可得：

$$
\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{q}} = \frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \delta \boldsymbol{\theta}} \cdot \frac{\partial \delta \boldsymbol{\theta}}{\partial \mathbf{q}}
$$

其中 $\frac{\partial \delta \boldsymbol{\theta}}{\partial \mathbf{q}}$ 是 3×4 矩阵（扰动向量对四元数的导数），工程中简化为：$\frac{\partial \delta \boldsymbol{\theta}}{\partial \mathbf{q}} = \begin{bmatrix} 0 & 2 & 0 & 0 \\ 0 & 0 & 2 & 0 \\ 0 & 0 & 0 & 2 \end{bmatrix}$

（因为 $\delta \mathbf{q}$ 的虚部是 $\frac{1}{2}\delta \boldsymbol{\theta}$，所以 $\delta \boldsymbol{\theta} = 2 \times [\delta q_x, \delta q_y, \delta q_z]^T$，实部 $\delta q_w = 1$ 对扰动无贡献）

#### 5. 最终：$\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{q}}$

代入后：

$$
\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{q}} = \frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{P}_c} \cdot \mathbf{R} \cdot [\Delta \mathbf{P}]_{\times} \cdot \begin{bmatrix} 0 & 2 & 0 & 0 \\ 0 & 0 & 2 & 0 \\ 0 & 0 & 0 & 2 \end{bmatrix}
$$

#### 6. 加权残差的雅可比$\frac{\partial \text{weighted\_res}}{\partial \mathbf{q}}$

$$
\frac{\partial \text{weighted\_res}}{\partial \mathbf{q}} = \sqrt{\Omega} \cdot \left( -\frac{\partial \mathbf{uv}_{\text{pred}}}{\partial \mathbf{q}} \right)
$$
