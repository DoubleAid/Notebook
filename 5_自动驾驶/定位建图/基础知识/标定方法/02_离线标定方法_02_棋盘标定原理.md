# 棋盘标定原理

## 核心思想

棋盘格标定的核心思想是：

利用一个已知尺寸和图案的精密棋盘格模板，通过多角度拍摄的图像，建立图像中可测量的二维像素点与三维世界点之间的对应关系，从而求解出相机的内部参数和外部参数。

它是一种基于三维到二维点对对应关系的标定方法。

## 为什么选择棋盘格？

棋盘格（Checkerboard）图案具有以下优点，使其成为理想的标定物：

1. 角点易于精确检测：棋盘格的角点（黑白方格的交点）是两条直线的交点，对比度高，可以通过图像处理算法（如OpenCV中的findChessboardCorners或findChessboardCornersSB）进行亚像素级别的精确定位。
2. 定义明确：每个角点都是“内角点”，不位于图像边界，避免了歧义。
3. 模式规则：方格的尺寸是已知且均匀的，可以轻松为每个检测到的角点分配其在棋盘世界坐标系中的三维坐标。通常设定棋盘平面为Z=0，从而简化计算。
4. 成本低廉：易于打印和制作。

## 基本原理与数学模型

### 相机成像模型（小孔成像模型）

这个过程可以用一个数学模型来描述：

$$
s \begin{bmatrix} u \\ v \\ 1 \end{bmatrix} =
\begin{bmatrix} f_x & 0 & c_x \\ 0 & f_y & c_y \\ 0 & 0 & 1 \end{bmatrix}
\begin{bmatrix} r_{11} & r_{12} & r_{13} & t_1 \\ r_{21} & r_{22} & r_{23} & t_2 \\ r_{31} & r_{32} & r_{33} & t_3 \end{bmatrix}
\begin{bmatrix} X_w \\ Y_w \\ Z_w \\ 1 \end{bmatrix}
$$

可以简写为：

$$
s \mathbf{p} = \mathbf{K} [\mathbf{R} | \mathbf{t}] \mathbf{P}
$$

其中：
+ $\mathbf{p} = [u, v, 1]^T$ ： 图像上的二维像素坐标。
+ s： 一个非零的尺度因子。
+ $\mathbf{K}$： 相机内参矩阵。这是我们标定的核心目标之一。
    + $f_x, f_y$： 相机在x和y方向上的焦距（以像素为单位）。
    + $c_x, c_y$： 主点（光轴与成像平面的交点，通常接近图像中心）的像素坐标。
+ $[\mathbf{R} | \mathbf{t}]$： 相机外参矩阵。对于每一张标定图片都不同。
    + $\mathbf{R}$：3x3的旋转矩阵，描述世界坐标系到相机坐标系的旋转。
    + $\mathbf{t}$：3x1的平移向量，描述世界坐标系到相机坐标系的平移。
+ $\mathbf{P} = [X_w, Y_w, Z_w, 1]^T$： 三维世界点的齐次坐标。

### 棋盘格引入的简化

我们将棋盘格平面定义为其自身的世界坐标系，通常将棋盘平面设为 $Z_w = 0$。这样，世界点就变成了 $\mathbf{P} = [X_w, Y_w, 0, 1]^T$

将 $Z_w = 0$ 代入成像模型后，公式可以大大简化。此时，外参矩阵的第三列 $\mathbf{r}_3$ 会与为零的 $Z_w$ 相乘而被消除。模型变为一个平面到平面的投影，即单应性变换：

$$
s \begin{bmatrix} u \\ v \\ 1 \end{bmatrix} =
\mathbf{K} [\mathbf{r}_1 \quad \mathbf{r}_2 \quad \mathbf{t}] 
\begin{bmatrix} X_w \\ Y_w \\ 1 \end{bmatrix} =
\mathbf{H}
\begin{bmatrix} X_w \\ Y_w \\ 1 \end{bmatrix}
$$

这里，$\mathbf{H}$ 是一个3x3的单应性矩阵，它直接联系了棋盘平面上的点 $(X_w, Y_w)$ 和图像平面上的点 $(u, v)$。

### 标定步骤解析

#### 第一步：数据采集
从不同角度、不同位置拍摄多张（通常10~20张）棋盘格图片。要求棋盘在图像中完整可见，且姿态（倾斜、旋转）有丰富的变化。

#### 第二步：角点检测与对应关系建立
对每张图片，算法自动检测出所有棋盘内角点的像素坐标 \((u, v)\)。同时，根据我们事先知道的棋盘信息（例如，每个方格的真实尺寸是25mm x 25mm），为每个角点分配其世界坐标 \((X_w, Y_w, 0)\)。这样就得到了大量的 2D-3D点对。

#### 第三步：计算单应性矩阵（每张图）
对于每一张图片，利用其上所有的角点对，通过最小二乘法等方法，可以求解出该图片对应的单应性矩阵 \mathbf{H}。

#### 第四步：由单应性矩阵约束求解内参

这是标定的核心数学部分。由于 $\mathbf{H} = \mathbf{K}[\mathbf{r}_1 \quad \mathbf{r}_2 \quad \mathbf{t}]$，而旋转矩阵的列向量具有单位正交的性质 

$（\mathbf{r}_1^T \mathbf{r}_2 = 0， |\mathbf{r}_1 = \mathbf{r}_2| = 1）$

这两个约束可以转换为关于内参矩阵 $\mathbf{K}$ 的方程。

具体地，可以推导出对于每张图片的 $\mathbf{H}$，都有两个约束方程：
$$
\mathbf{h}_1^T \mathbf{K}^{-T} \mathbf{K}^{-1} \mathbf{h}_2 = 0
$$

$$
\mathbf{h}_1^T \mathbf{K}^{-T} \mathbf{K}^{-1} \mathbf{h}_1 = \mathbf{h}_2^T \mathbf{K}^{-T} \mathbf{K}^{-1} \mathbf{h}_2
$$

其中 $\mathbf{h}_1, \mathbf{h}_2$ 是 $\mathbf{H}$ 的前两列。

设 $\mathbf{B} = \mathbf{K}^{-T} \mathbf{K}^{-1}$， $\mathbf{B}$ 是一个对称矩阵，由内参决定。将多张图片（>=3张）的约束方程堆叠起来，就可以组成一个齐次线性方程组，求解出 $\mathbf{B}$。再通过Cholesky分解，即可从中解出相机的内参矩阵 $\mathbf{K}$。

#### 第五步：求解外参（每张图）

在得到内参 \mathbf{K} 后，对于每张图片，其外参可以通过以下公式恢复：
$$
\mathbf{r}_1 = \lambda \mathbf{K}^{-1} \mathbf{h}_1, \quad
\mathbf{r}_2 = \lambda \mathbf{K}^{-1} \mathbf{h}_2, \quad
\mathbf{r}_3 = \mathbf{r}_1 \times \mathbf{r}_2, \quad
\mathbf{t} = \lambda \mathbf{K}^{-1} \mathbf{h}_3
$$

其中 $\lambda = 1 / |\mathbf{K}^{-1} \mathbf{h}_1|$ 是一个归一化因子。

由于噪声存在，恢复出的 $[\mathbf{r}_1, \mathbf{r}_2, \mathbf{r}_3]$ 可能不满足严格的旋转矩阵性质，通常需要通过奇异值分解（SVD）求一个最接近的正交矩阵。

#### 第六步：非线性优化（束调整）

以上步骤得到的参数是解析解或线性最优解，但并非在最大似然意义下的最优解。最后一步，我们会以这些解作为初始值，进行一个非线性优化（通常使用Levenberg-Marquardt算法），最小化重投影误差。

+ 重投影误差：将计算得到的三维角点，用当前估计的相机参数重新投影到图像上，得到投影点。计算投影点与实际检测到的角点之间的像素距离的平方和。这个误差是标定精度的直接体现。

优化所有参数（一套内参 + 所有图片的外参），使得总的重投影误差最小。这个过程就是最大似然估计，能得到最精确、最稳定的标定结果。

### 标定结果

完成上述过程后，我们得到：

1.  相机内参： $f_x, f_y, c_x, c_y$。有时还包括畸变系数（径向畸变 $k_1, k_2, k_3$， 切向畸变 $p_1, p_2$），它们会在非线性优化阶段一同被求解和优化。
2.  相机外参（对于每一张标定图）： 旋转矩阵 $\mathbf{R}$ 和平移向量 $\mathbf{t}$。在后续应用中，如果相机位置固定，这些外参可以丢弃。

## 五、总结与评价

优点：

+ 原理清晰，数学基础坚实。
+ 实现成熟，OpenCV等库提供了完整函数（cv::calibrateCamera）。
+ 精度高，在良好操作下可以达到很高的标定精度。
+ 能同时估计畸变，得到可用于图像校正的畸变系数。

局限性：

+ 依赖于一个精确制造的平面标定板。
+ 需要多张不同姿态的图片，采集过程需人工操作。
+ 标定精度受角点检测精度、图片数量和质量影响。

总之，棋盘格标定是一种通过建立已知三维点与二维图像点之间的对应关系，利用几何约束和优化方法，反向求解相机成像模型参数的强大而实用的技术。它是计算机视觉、机器人、三维重建等领域的基础步骤。
