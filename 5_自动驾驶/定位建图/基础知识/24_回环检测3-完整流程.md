# 回环检测-完整流程

在图优化（如 SLAM 后端）中，回环检测因子的核心作用是修正全局位姿漂移—— 通过检测 “当前帧与历史帧（或地图关键帧）的重访关系”，构建额外的相对位姿约束，与里程计因子（如 IMU 预积分、激光配准）、GPS 因子等共同优化全局状态。以下从 “因子添加流程” 和 “权重判定方法” 两方面，结合工程实践详细说明：

## 一、图优化中添加回环检测因子的完整流程

回环因子的添加是 “回环检测→约束建模→因子构建→融入优化” 的闭环，核心是将 “回环匹配结果” 转化为图优化可识别的 “边约束”，具体步骤如下：

### 1. 第一步：回环检测（前提：找到可靠回环对）

先通过算法检测 “当前帧（或关键帧）k 与历史关键帧 i” 是否属于同一物理位置（重访），输出可靠的回环对（i, k）。常用回环检测方法：

+ 激光 SLAM：NDT/ICP 配准（直接匹配点云）、特征匹配（如 FPFH+RANSAC）、Place Recognition（如 Scan Context、OverlapNet）；
+ 视觉 SLAM：BoW 字典（如 ORB-SLAM 的 DBoW2）、深度学习特征（如 SuperPoint）；
+ 多传感器融合：激光 + 视觉联合特征（如 PointVLAD）。

回环检测需输出两个核心结果：

+ 回环对：（历史关键帧 i，当前关键帧 k）；
+ 相对位姿：$\Delta \mathbf{T}_{k,i} = (\Delta \mathbf{q}_{k,i}, \Delta \mathbf{p}_{k,i})$（i 帧到 k 帧的相对旋转四元数、相对位置向量，通常在世界系或 i 帧系下表示）；
+ 匹配置信度：如点云重叠率、特征匹配数、配准误差（RMSE）等（用于后续权重判定）。

### 2. 第二步：回环约束建模（定义误差项）

图优化中，“因子” 本质是 “误差项的数学表达”，回环因子的核心是强制 “回环检测得到的相对位姿” 与 “图中当前估计的相对位姿” 一致。

#### （1）符号约定

+ 图中关键帧 i 的绝对位姿：$\mathbf{T}_i = (\mathbf{q}_i, \mathbf{p}_i)$（世界系下的旋转四元数、位置向量）；
+ 图中关键帧 k 的绝对位姿：$\mathbf{T}_k = (\mathbf{q}_k, \mathbf{p}_k)$；
+ 回环检测得到的 i→k 相对位姿：$\Delta \mathbf{T}_{k,i} = (\Delta \mathbf{q}_{k,i}, \Delta \mathbf{p}_{k,i})$（物理意义：\(\mathbf{T}_k = \mathbf{T}_i \otimes \Delta \mathbf{T}_{k,i}\)，即 i 帧位姿乘以相对位姿得到 k 帧位姿）。

#### （2）回环误差项定义

回环因子的误差项是 “图中估计的相对位姿” 与 “回环检测的相对位姿” 的差值，确保两者一致。分旋转和位置误差：

$$
\boxed{
\begin{cases}
\mathbf{e}_q = (\mathbf{q}_i^* \otimes \mathbf{q}_k) \otimes (\Delta \mathbf{q}_{k,i})^* \quad (\text{旋转误差}) \\
\mathbf{e}_p = \mathbf{p}_k - (\mathbf{p}_i + \mathbf{R}_i \cdot \Delta \mathbf{p}_{k,i}) \quad (\text{位置误差})
\end{cases}
}
$$

+ 旋转误差$\mathbf{e}_q$：四元数乘法的一致性约束，理想情况下$\mathbf{q}_k = \mathbf{q}_i \otimes \Delta \mathbf{q}_{k,i}$，故$\mathbf{e}_q = \mathbf{I}$（单位四元数），实际中转换为 3 维旋转向量（避免四元数冗余）；
+ 位置误差$\mathbf{e}_p$：位置向量的一致性约束，理想情况下$\mathbf{p}_k = \mathbf{p}_i + \mathbf{R}_i \cdot \Delta \mathbf{p}_{k,i}$（$\mathbf{R}_i$是$\mathbf{q}_i$对应的旋转矩阵），故$\mathbf{e}_p = \mathbf{0}$；
+ 误差项维度：旋转误差 3 维 + 位置误差 3 维 = 6 维（与位姿状态维度一致）。

### 3. 第三步：构建回环因子（融入图优化）

图优化的 “节点” 是关键帧的绝对位姿（$\mathbf{q}_i, \mathbf{p}_i, \mathbf{q}_k, \mathbf{p}_k$），“边” 是因子（里程计因子、回环因子等）。回环因子作为一条 “边”，连接节点 i 和节点 k，具体操作：

+ 在因子图中添加一条 “二元边”（连接节点 i 和 k），边的类型为 “回环因子”；
+ 将误差项$(\mathbf{e}_q, \mathbf{e}_p)$和权重矩阵（下文重点说明）传入因子；
+ 工程实现：通过因子图库（如 g2o、Ceres Solver）的接口定义自定义因子，实现误差项计算和雅可比矩阵求解（Ceres 会自动求导，g2o 需手动实现）。

### 4. 第四步：全局优化与状态更新

添加回环因子后，全局优化目标函数变为所有因子的加权误差和：

$$
\text{Cost} = \sum\text{里程计因子误差}^T \mathbf{W}_{\text{odo}} \text{里程计因子误差} + \sum \text{回环因子误差}^T \mathbf{W}_{\text{loop}} \text{回环因子误差} + \dots
$$
通过 LM（Levenberg-Marquardt）算法最小化 Cost 函数，更新所有关键帧的绝对位姿，修正全局漂移。

## 二、回环检测因子的权重判定方法（核心：$\mathbf{W}_{\text{loop}}$）

回环因子的权重（即权重矩阵$\mathbf{W}_{\text{loop}}$）决定了 “回环约束对全局优化的影响程度”—— 权重越大，回环约束越 “强硬”，越能修正漂移，但不可靠的回环（权重过高）会导致优化发散；权重越小，回环约束越 “软弱”，无法有效修正漂移。

权重的本质是 “回环检测结果的可靠性度量”，工程中常用 “噪声协方差矩阵的逆” 作为权重矩阵（即$\mathbf{W}_{\text{loop}} = \Sigma_{\text{loop}}^{-1}$），核心逻辑：回环越可靠，噪声协方差$\Sigma_{\text{loop}}$越小，权重越大。

### 1. 权重矩阵的形式

回环因子的权重矩阵是 6×6 对角矩阵（旋转和位置误差独立加权），形式如下：

$$
\mathbf{W}_{\text{loop}} = \text{diag}\left( \frac{1}{\sigma_{q,x}^2}, \frac{1}{\sigma_{q,y}^2}, \frac{1}{\sigma_{q,z}^2}, \frac{1}{\sigma_{p,x}^2}, \frac{1}{\sigma_{p,y}^2}, \frac{1}{\sigma_{p,z}^2} \right)
$$

+ $\sigma_q = (\sigma_{q,x}, \sigma_{q,y}, \sigma_{q,z})$：旋转误差的标准差（3 维，对应旋转向量的三个分量）；
+ $\sigma_p = (\sigma_{p,x}, \sigma_{p,y}, \sigma_{p,z})$：位置误差的标准差（3 维）；
+ 若认为旋转 / 位置各轴噪声一致，可简化为：$\mathbf{W}_{\text{loop}} = \text{diag}\left( \frac{1}{\sigma_q^2}, \frac{1}{\sigma_q^2}, \frac{1}{\sigma_q^2}, \frac{1}{\sigma_p^2}, \frac{1}{\sigma_p^2}, \frac{1}{\sigma_p^2} \right)$。

### 2. 权重判定的 3 类核心方法（工程常用）

#### 方法 1：基于回环检测的 “匹配质量指标” 自适应加权（最常用）

直接利用回环检测过程中输出的 “可靠性指标”，映射为噪声协方差$\Sigma_{\text{loop}}$，再求逆得到权重。

| 回环类型 | 可靠性指标 | 权重映射逻辑（示例）|
| ---- | ---- | ---- |
| 激光点云配准 | 点云重叠率r（0~1）、配准 RMSEe | - 重叠率r：$\sigma_p = \frac{0.5}{r}$（$r=1$时$\sigma_p=0.5m$，$r=0.5$时$\sigma_p=1m$）；<br> - RMSEe：$\sigma_p = e \times 2$（配准误差越大，噪声越大，权重越小）；|
| 视觉特征匹配 | 有效匹配特征数n、BoW 相似度s | - 匹配数n：$\sigma_q = \frac{5^\circ}{n/50}$（$n=100$时$\sigma_q=2.5^\circ$，$n=50$时$\sigma_q=5^\circ$）；<br> - 相似度s：$\mathbf{W}_{\text{loop}} = s \times \mathbf{W}_{\text{max}}$（$\mathbf{W}_{\text{max}}$是最大权重）；|
| 深度学习 Place Recognition | 置信度分数c（0~1）| - 置信度c：$\sigma_q = \frac{3^\circ}{c}$，$\sigma_p = \frac{0.3m}{c}$（置信度越高，噪声越小）；|

示例（激光 SLAM 回环）：

回环检测得到重叠率$r=0.8$，配准 RMSE$e=0.1m$，则：

+ 位置噪声$\sigma_p = e \times 1.5 = 0.15m$，位置权重$\frac{1}{\sigma_p^2} \approx 44.4$；
+ 旋转噪声$\sigma_q = \frac{2^\circ}{r} = 2.5^\circ$（转换为弧度$\approx 0.0436rad$），旋转权重$\frac{1}{\sigma_q^2} \approx 533.1$；
+ 权重矩阵$\mathbf{W}_{\text{loop}} = \text{diag}(533.1, 533.1, 533.1, 44.4, 44.4, 44.4)$。

#### 方法 2：基于 “回环与里程计的一致性” 动态加权（鲁棒性更强）

回环可能存在 “误匹配”（如相似场景误判），此时需通过 “回环约束与现有里程计约束的一致性” 验证回环可靠性，调整权重：

1. 计算 “图中当前估计的 i→k 相对位姿”：$
\Delta \mathbf{T}_{k,i}^{\text{est}} = \mathbf{T}_i^* \otimes \mathbf{T}_k
$（由当前优化后的 i、k 帧位姿推导）；
2. 计算 “回环检测的相对位姿” 与 “估计的相对位姿” 的偏差：
    $$
    \Delta \mathbf{e} = (\Delta \mathbf{q}_{k,i} \otimes (\Delta \mathbf{q}_{k,i}^{\text{est}})^*, \Delta \mathbf{p}_{k,i} - \Delta \mathbf{p}_{k,i}^{\text{est}})
    $$
3. 权重调整逻辑：

    + 若偏差$\Delta \mathbf{e} < \text{阈值}$（如旋转 < 5°、位置 < 0.5m）：回环可靠，权重设为方法 1 的计算值；
    + 若偏差$\Delta \mathbf{e}$介于阈值 1 和阈值 2 之间：回环半可靠，权重乘以衰减系数（如 0.5）；
    + 若偏差$\Delta \mathbf{e} > \text{阈值2}$：回环误匹配，丢弃该回环因子（权重设为 0）。

工程价值：避免误匹配回环导致优化发散，尤其适用于动态场景或相似环境。

#### 方法 3：固定权重（简单易实现，适合快速验证）

若回环检测算法鲁棒性极高（如室内结构化场景、无相似重复场景），可直接设置固定权重，无需自适应调整：

+ 旋转权重：$\frac{1}{\sigma_q^2}$，其中$\sigma_q = 1^\circ \sim 3^\circ$（根据传感器精度调整）；
+ 位置权重：$\frac{1}{\sigma_p^2}$，其中$\sigma_p = 0.1m \sim 0.5m$（激光 SLAM 常用 0.2m，视觉 SLAM 常用 0.5m）；示例：$\mathbf{W}_{\text{loop}} = \text{diag}(1000, 1000, 1000, 100, 100, 100)$（旋转权重高于位置，因为旋转漂移对全局影响更大）。

### 3. 权重判定的关键原则

1. 与传感器精度匹配：激光 SLAM 的回环位置权重可设得更大（激光配准精度高），视觉 SLAM 的权重需偏小（视觉易受光照影响，噪声大）；
2. 旋转权重≥位置权重：旋转漂移累积更快，回环对旋转的约束优先级更高；
3. 避免权重过大或过小：
    + 权重过大：回环约束 “绑架” 优化，即使回环有微小误差，也会导致全局位姿剧烈调整；
    + 权重过小：回环约束无法抵消里程计漂移，失去回环的核心价值；
4. 多回环融合：若同一帧 k 与多个历史帧（i1, i2, ...）都检测到回环，可按权重加权融合为一个综合回环因子，或分别添加多个因子（权重各自判定）。

## 三、工程实现注意事项

1. 回环因子的鲁棒化处理：
    + 加入 Huber 核函数：当回环误差过大时（如误匹配），自动降低该因子的权重，避免优化发散（g2o/Ceres 均支持鲁棒核）；
    + 回环验证：添加回环因子后，先进行局部优化，若优化后误差仍过大，删除该回环因子。
2. 坐标系一致性：确保回环检测的相对位姿与图中绝对位姿的坐标系一致（如均为世界系），否则需通过坐标变换统一。
3. 关键帧筛选：回环检测仅在关键帧之间进行（避免帧过多导致计算量爆炸），关键帧筛选标准：位姿变化量、点云 / 特征信息量。
4. 权重调参技巧：初始值：按传感器类型设固定权重（激光：$\sigma_q=2^\circ, \sigma_p=0.2m$；视觉：$\sigma_q=5^\circ, \sigma_p=0.5m$）；迭代调整：根据优化后的回环误差（理想误差≈0）调整，若误差过大，增大权重；若优化后位姿抖动，减小权重。

## 四、总结

回环因子添加流程：回环检测（找对）→ 约束建模（误差项）→ 因子构建（连边）→ 全局优化（更新位姿）；权重判定核心：权重 = 回环可靠性的倒数，工程中优先用 “匹配质量自适应加权”（简单高效），复杂场景叠加 “一致性验证动态加权”（鲁棒）；核心目标：让可靠的回环约束充分修正漂移，同时避免误匹配回环破坏全局一致性。通过以上方法，回环因子能有效融入图优化，最终输出无漂移的全局位姿（如激光 SLAM 的全局地图、视觉 SLAM 的轨迹）。
