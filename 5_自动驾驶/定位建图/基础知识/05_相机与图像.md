# 相机与图像

## <font color="SkyBlue">相机模型</font>

### <font color="YellowGreen">针孔相机模型</font>

针孔相机模型是最简单的相机模型，假设相机的光轴通过图像平面的中心，并且图像平面与相机的光轴垂直。在这种模型下，相机的成像过程可以看作是光线通过一个针孔（即相机的光轴）进入图像平面，形成一个倒立的图像。

假设 光心在 $O$，焦距为 $f$，物体距光心为 $Z$, 投影的位置为 $X', Y'$，真实的位置为 $X, Y$

根据相似三角形原理，可以得到以下关系：

$$
\frac{Z}{f} = -\frac {X} {X'} = -\frac {Y} {Y'}
$$

其中负号表示成的像是倒立的。为了简化将负号去掉

$$
\frac{Z}{f} = \frac {X} {X'} = \frac {Y} {Y'} \\
X' = f \frac X Z \\
Y' = f \frac Y Z
$$

假设在物理成像平面上固定着一个像素平面 o u v, 我们在像素平面上得到了 $p^,$ 的像素坐标：$[u, v]^T$

像素坐标系通常的定义方式是：原点o′ 位于图像的左上角，u
轴向右与x 轴平行，v 轴向下与y 轴平行。

像素坐标系与成像平面之间，相差了一个缩放 和一个原点的平移。

我们设像素坐标在u 轴上缩放了α倍 ，在v 上缩放了β 倍。同时，原⛩平移了[cx ,cy ]T 。

因此像素坐标系与成像平面之间的关系为：

$$
u = \alpha X^, + c_x \\
v = \beta Y^, + c_y
$$

将 $\alpha f = f_x$ 和 $\beta f = f_y$ 代入上式，得到：

$$
u = f_x \frac X Z + c_x \\
v = f_y \frac Y Z + c_y
$$

其中 $f_x$ 和 $f_y$ 分别是图像的水平和垂直焦距，$c_x$ 和 $c_y$ 分别是图像的主点坐标。

$$
\begin{bmatrix}
u \\
v \\
1
\end{bmatrix} = \frac 1 Z \begin{bmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1
\end{bmatrix} \begin{bmatrix}
X \\
Y \\
Z
\end{bmatrix} = \frac 1 Z K P
$$

在该式中，我们把中间的量组成的矩阵称为相机的**内参数矩阵** (CameraIntrinsics) K, 通常任务，相机的内参在出厂后是固定的，在使用中不会发生改变

有内参就有外参，外参就是相机相对于世界坐标系的变换矩阵，即相机的位姿。相机的位姿可以用旋转矩阵 R 和平移向量 t 来表示，即：

$$
ZP_{uv} = Z\begin{bmatrix}
u \\
v \\
1
\end{bmatrix} = K(RP_w+t) = KTP_w
$$

也就是相机相对于世界坐标系的变换矩阵，也就是相机的位姿 R, t, 也称为相机的外参

其中可以看出来 $TP_w$ 就是在相机坐标系下，一个点的位置

$$
P_c = \begin{bmatrix}
X \\
Y \\
Z
\end{bmatrix} = (TP_W)_{(1:3)} 
$$

因为相机成像并不考虑深度，想象一下，将相机所拍摄的物体就是一个二维的平面，那么成像的位置就是

$$
P_c = \begin{bmatrix}
\frac X Z \\
\frac Y Z \\
1
\end{bmatrix} 
$$

这个二位平面叫做 归一化图像平面

### <font color="YellowGreen">畸变</font>

为了获得好的成像效果，我们在相机的前方加了透镜。透镜的加入对成像过程中光线的传播会产生新的影响：

一是透镜自身的形状对光线传播的影响
二是在机械组装过程中，透镜和成像平面不可能完全平行，这也会֯使得光线穿过透镜投影到成像面时的位置发生变化。

由透镜形状引起的畸变称为径向畸变，主要分为两种：桶形畸变 和 枕形畸变。

除了径向畸变，由机械组装引起的畸变称为切向畸变。

对于径向畸变，无论是桶型畸变还是枕形畸变，由于他们都是随着中心之间的距离增加而增加，因此可以用
一个多项式函数来描述畸变前后的坐标变化：

这类畸变可以用与距中心的距离有关的二次及高次多项式函数进行纠正。 其中 $[x, y]^T$ 是为纠正的畸变前的坐标，$[x^,, y^,]^T$ 是为纠正的畸变后的坐标，$[k_1, k_2, k_3, k_4]^T$ 是畸变系数，$r^2 = x^2 + y^2$ 是距中心的距离的平方。则畸变校正公式为：

$$
x^, = x(1 + k_1r^2 + k_2r^4 + k_3r^6) \\
y^, = y(1 + k_1r^2 + k_2r^4 + k_3r^6)
$$

在这个纠正模型中，对于畸变较小的图像中心区域，畸变纠正主要是靠 $k_1$ 起作用，对于畸变较大的边缘区域，畸变纠正主要是靠 $k_2$ 起作用。对于畸变很大的摄像头，比如鱼眼相机，可以加入 $k_3$ 畸变项对畸变进行修正

对于切向畸变，可以使用另外两个参数 $p_1, p_2$ 来进行纠正

$$
x^, = x + 2p_1xy + p_2(r^2 + 2x^2) \\
y^, = y + p_1(r^2 + 2y^2) + 2p_2xy
$$

因此，对于相机坐标系下的任意一点 P (x, y, z), 我们能够通过5个畸变系数找到这个点在像素平面上的正确位置

1. 将三维空间点投影到归一话图像平面。假设他的坐标是 $[x, y]^T$
2. 对归一话平面上的点进行径向畸变和切向畸变纠正

$$
x^, = x(1 + k_1r^2 + k_2r^4 + k_3r^6) + 2p_1xy + p_2(r^2 + 2x^2) \\
y^, = y(1 + k_1r^2 + k_2r^4 + k_3r^6) + p_1(r^2 + 2y^2) + 2p_2xy
$$

将纠正后的点通过内参数矩阵投影到像素平面，就得到了该点在图像上的正确位置

$$
u = f_xx^, + c_x \\
v = f_yy^, + c_y
$$

总结一下单目像机的成像过程

1. 首先，世界坐标系下有一个固定的点，世界坐标为 P_w
2. 由于相机在运动，他的运动由 R， t或者变换矩阵 $T \in SE(3)$ 描述，P的相机坐标为 $P_c = R P_w + t$
3. 这时的P_c 位于归一化图像平面，归一化图像平面的坐标为 $P_n = P_c / Z$
4. 由于相机的畸变，需要对 $P_n$ 进行畸变校正，得到 $P_d$
5. 通过内参数矩阵 K，将 $P_d$ 投影到像素平面，得到 $P_p = K P_d$

### <font color="YellowGreen">双目相机模型</font>

对于双目相机，可以把两个相机都看作针孔相机。两者之间的距离称为双目相机的基线 (Baseline)。假设两个相机的光心分别为 $O_L$ 和 $O_R$，焦距为 $f$，基线为 $b$，那么对于一个点 $P_w$，在两个相机的成像平面中，分别有 $P_L$ 和 $P_R$ 两个点。

仅以水平考虑，计 $u_r$ 和 $u_l$ 为成像平面的坐标，那么根据相似三角形原理，可以得到以下关系：

$$
z = \frac{fb}{u_L - u_R} = \frac{fb}{d}, d = u_L - u_R
$$

这里，d为左右图的横坐标之差，称为视差 (Disparity)。我们可以估计一个像素和相机的距离，视差与距离成反比，视差越大，距离越近

虽然公式比较简洁，但视差d本身的计算比较困难，，我们需要知道左眼图和右眼图的对应关系

### <font color="YellowGreen">RGB-D相机模型</font>

1. 使用红外结构光或者激光雷达测距

## <font color="SkyBlue">总结</font>

### <font color="YellowGreen">归一化平面</font>

归一化平面上的一个点对应着的是从光心的一条射线上的所有点
$$
\begin{bmatrix}
X^, \\
Y^, \\
1
\end{bmatrix} = \begin{bmatrix}
f\frac X Z \\
f\frac Y Z \\
1
\end{bmatrix}
$$
像素平面是获取图像的平面

世界平面就是真实世界的坐标系

畸变包括径向畸变和切向畸变

径向畸变的修正
$$
x_{修正} = x(1 + k_1r^2 + + k_2r^4 + k_3r^6) \\
x_{修正} = x(1 + k_1r^2 + + k_2r^4 + k_3r^6)
$$

双目相机可以计算相机深度
$$
z = \frac {fb} {u_L - u_R}
$$
