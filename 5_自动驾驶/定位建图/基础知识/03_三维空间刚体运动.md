# 三维空间刚体运动

## 主要目标

1. 理解三维空间的刚体运动描述方式：旋转矩阵，变换矩阵，四元数和欧拉角
2. 掌握Eigen库的矩阵，几何模块的使用方法

## <font color="Skyblue">旋转矩阵</font>

在三位空间内使用三个轴的坐标来标识位置，一般情况下使用右手定则，z轴方向由 x -> y 右手定则确定

接下来介绍两个运算方式

**内积**： $a \cdot b = a_x b_x + a_y b_y + a_z b_z = |a||b|cos(a,b)$

内积可以描述为向量间的投影关系

**外积**：两个向量的叉积，计算公式为 

$a \times b = (a_y b_z - a_z b_y, a_z b_x - a_x b_z, a_x b_y - a_y b_x) = \begin{bmatrix}
i & j & k \\
a_1 & a_2 & a_3 \\
b_1 & b_2 & b_3
\end{bmatrix}$ = $\begin{bmatrix}
a_2b_3 - a_3b_2 \\
a_3b_1 - a_1b_3 \\
a_1b_2 - a_2b_1
\end{bmatrix}$ = $\begin{bmatrix}
0 & -a_3 & a_2 \\
a_3 & 0 & -a_1 \\
-a_2 & a_1 & 0
\end{bmatrix}b$ = a^b

外积的方向垂直于这两个向量，大小为 |a||b|sin(a, b) 是这两个向量组成的矩形的面积

把$a \times$写成一个矩阵，称为反对称矩阵（Skew-symmetric）

外积只对三维向量存在定义，我们还能用外积标识向量的旋转

考虑两个不平行的向量a和b，它们的外积c = a^b，c的方向垂直于a和b，大小为 |a||b|sin(a, b)，c的大小可以看作是a和b之间的夹角的正弦值，c的方向可以看作是a和b之间的夹角的正弦值的方向

### <font color="YellowGreen">坐标系件的欧式变换</font>

**欧式变换** 相机运动是一个刚体运动，它保证同一个向量在各个坐标系下的长度和角度不会发生改变, 也就是只改变向量的描述，不修改向量的信息

与向量的旋转类似，同样可以描述两个坐标系之间的旋转关系，再加上平移，统称为坐标系之间的变换关系，

通常情况下设定一个惯性坐标系（或者叫世界坐标系）作为参考系，认定其位置不变
同时机器人的坐标系是一个移动坐标系，其位置会随着机器人的运动而改变

假设相机视野中有一个点，其坐标为 $P_c$，在世界坐标系下的坐标为 $P_w$，这两个坐标之间是如何转换的呢

首先，假设相机的坐标系相对于世界坐标系有一个旋转矩阵R，以及一个平移向量T

先来考虑旋转，某一个单位的正交基 $(e_1,e_2,e_3)$ 经过一次旋转变成了 $(e^,_1, e^,_1, e^,_1)$
那么对弈同一个向量a（注意该向量并没有随着坐标系的旋转而发生运动），它在两个坐标系下的坐标为 $[a_1,a_2,a_3]^T$ 和 $[a^,_1, a^,_1, a^,_1]^T$

它在两个坐标系之间的转换为

$$
[e_1,e_2,e_3]
\begin{bmatrix}
a_1 \\
a_2 \\
a_3
\end{bmatrix}
= [e^,_1, e^,_1, e^,_1]
\begin{bmatrix}
a_1^, \\
a_2^, \\
a_3^,
\end{bmatrix}
$$

如果同时左右两边同时左乘以 $\begin{bmatrix}
e_1^T \\
e_2^T \\
e_3^T
\end{bmatrix}$，左边就变成了单位矩阵（因为e是单元基，自己的内积为单位长），所以：

$$
\begin{bmatrix}
a_1 \\
a_2 \\
a_3
\end{bmatrix}
= \begin{bmatrix}
e_1^Te_1^, & e_1^Te_2^, & e_1^Te_3^, \\
e_2^Te_1^, & e_2^Te_2^, & e_2^Te_3^, \\
e_3^Te_1^, & e_3^Te_2^, & e_3^Te_3^,
\end{bmatrix}
\begin{bmatrix}
a_1^, \\
a_2^, \\
a_3^,
\end{bmatrix}
=Ra^,
$$

我们把中间的矩阵拿出来，定义为矩阵R，这个矩阵由两组基之间的内积组成，刻画了旋转旋转前后同一个向量的坐标转换关系。所以说矩阵R描述了旋转本身，称为旋转矩阵

旋转矩阵由一些性质

+ 他是一个行列式为1的蒸饺矩阵 <==> 行列式为1的正交矩阵也是一个旋转矩阵
+ 他的转置矩阵是他的逆矩阵，即 $R^T = R^{-1}$

所以把旋转矩阵的集合定义为

$$
SO{n} = \{ R \in \mathbb{R}^{3 \times 3} \mid R^T R = I, \det(R) = 1 \}
$$

SO(n) 是特殊正交群，n=3，表示三维空间的旋转矩阵

由于旋转矩阵为正交矩阵，他的逆（即转置）描述了一个相反的旋转 $a^, = R^{-1}a = R^Ta$

在欧式变换中，除了旋转还有平移，将其拼合在一起就变成了 $a^, = Ra + t$

但这个公式并不满足线性变换的性质，因为平移部分不满足线性变换的性质，所以需要引入一个额外的维度，将平移向量变成一个四维向量

$$
\begin{bmatrix}
a^, \\
1
\end{bmatrix} = 
\begin{bmatrix}
R & t \\
0^T & 1
\end{bmatrix}
\begin{bmatrix}
a \\
1
\end{bmatrix}
= T\begin{bmatrix}
a \\
1
\end{bmatrix}
$$

这样 4x4 的矩阵 T 就描述了坐标系之间的欧式变换，称为变换矩阵

$$
SE(3) = \{ T = \begin{bmatrix}
R & t \\
0^T & 1
\end{bmatrix} \in \mathbb{R}^{4 \times 4} \mid R \in SO(3), t \in \mathbb{R}^3 \}
$$

与 SO(3) 一样， 求解该矩阵的逆表示一个反向的变换

$$
T = \begin{bmatrix}
R^T & -R^Tt \\
0^T & 1
\end{bmatrix}
$$

## <font color="skyblue">旋转向量和欧拉角</font>

### <font color="YellowGreen">旋转向量</font>

变换矩阵来描述6自由度的三维刚体运动有几个缺点

1. SO(3) 的旋转矩阵有9个量，一次旋转需三个自由度，平移需三个自由度，所以只需6个自由度，用9个量来描述3个自由度的刚体运动，用16个量表达了6自由度的变换矩阵,不紧凑
2. 旋转矩阵是一个正交矩阵且行列式为1的约束，想要估计或优化一个旋转矩阵/变换矩阵时，这些约束会使求解变得更困难

由之前的外积都可以用一个旋转轴和一个旋转角来刻画，这种向量称为旋转向量（或轴角）

对于变换矩阵，可以使用一个旋转向量和一个平移向量即可表达一次变换，这时的维度正好是六维

假设有一个旋转轴为 n，旋转角度为 $\theta$, 它对应的旋转向量为 $\theta n$, 从旋转向量到旋转矩阵的变换过程由 罗德里格斯公式表明

$$
R = cos\theta I + (1-cos\theta)nn^T + sin\theta[n^T \times]
$$

也可以计算一个旋转矩阵到一个旋转向量的转换，对于转角 $\theta$ 有

$$
\theta = arccos(\frac {tr(R) - 1 }2)
$$

还有一个特性就是 旋转轴上的向量经过旋转不会发生任何改变

$$
Rn = n
$$

### <font color="YellowGreen">欧拉角</font>

无论是旋转矩阵和旋转向量，虽然能描述旋转，但对人类来说非常不直观，而欧拉角提供了一种非常直观的方式来描述旋转 --- 它使用了三个分类的转角，把一个旋转分解成3次绕不同轴的旋转

常见的欧拉角使用

1. 绕物体的Z轴旋转，得到偏航角 yaw
2. 绕旋转后的Y轴旋转，得到俯仰角 pitch
3. 绕旋转之后的X轴旋转，得到滚转角 roll

因此可以使用 $[r, p, y]^T$ 这样一个三维的向量描述任意旋转

欧拉角有一个重大缺点，也是所有3维参数描述的缺点，在俯仰90度时，第一次旋转和第三次旋转将使用同一个轴，这使系统丢失了一个自由度，这称为奇异性问题，因此欧拉角不适用于差值和迭代，往往只适用于人机交互和结果的验证

## <font color="Skyblue">四元数</font>

四元数既是紧凑的，也没有奇异性，但四元数不够直观，运算稍复杂些，

一个四元数q拥有一个实部和三个虚部，即

$$
q = q_0 + q_1i + q_2j + q_3k
$$

其中 i，j, k 为四元数的三个虚部，这三个虚部满足一下关系式

$$
\left\{
\begin{aligned}
i^2 = j^2 = k^2 = -1 \\
ij = k, ji = -k \\
jk = i, kj = -i \\
ki = j, ik = -j
\end{aligned}
\right.
$$

由于这种特殊表示形式，也有人用一个标量和一个向量来表达四元数

假设某个旋转是绕单位向量 $n = [n_x, n_y, n_z]^T$ 进行了角度为 $\theta$ 的旋转，那么这个旋转的四元数为

$$
q = [cos{\frac \theta 2}, n_xsin{\frac \theta 2}, n_ysin{\frac \theta 2}, n_zsin{\frac \theta 2}]^T
$$

反之，也可以从单位四元数种计算出对用旋转轴和夹角

$$
\left\{
\begin{aligned}
\theta = 2arccosq_0 \\
[n_x, n_y, n_z]^T = \frac {[q_1, q_2, q_3]^T}{sin{\frac \theta 2}}
\end{aligned}
\right.
$$

任意的旋转都可以由两个互为相反数的四元数表示

### 四元数的运算

现在有两个四元数
$$
q_a = s_a + x_ai + y_aj + z_ak
$$
$$
q_b = s_b + x_bi + y_bj + z_bk
$$

#### <font color="Coral">加发和减法</font>

$$
q_a \pm q_b = [s_a \pm s_b, v_a \pm v_b]
$$

#### <font color="Coral">乘法</font>

$$
q_aq_b = s_as_b - x_ax_b - y_ay_b - z_az_b \\
        + (s_ax_b + x_as_b + y_az_b - z_ay_b) i \\
        + (s_ay_b + x_az_b + y_as_b - z_ax_b) j \\
        + (s_az_b + x_ay_b + y_ax_b - z_as_b) k
$$

虽然稍微负载，但形式上是整齐有序的，如果写成向量形式并利用内外积运算

$$
q_aq_b = [s_as_b - v_a^Tv_b, s_av_b + s_bv_a + v_a \times v_b]
$$

#### <font color="Coral">共轭</font>

四元数的共轭是把虚部取成相反数

$$
q_a^* = s_a - x_ai - y_aj - z_ak = [S_a, -V_a]
$$

四元数的共轭与本身相乘，会得到实四元数，其实部为模长的平方

$$
q^*q = qq^* = [s_a^2 + v^Tv, 0]
$$

#### <font color="Coral">模长</font>

$$
||q_a|| = \sqrt {s_a^2 + x_a^2 + b_a^2 + z_a^2}
$$

#### <font color="Coral">逆</font>

$$
q^{-1} = \frac {q^*} {||q||^2}
$$

#### <font color="Coral">点乘</font>

$$
kq = [k_s, k_v] \\
q_a.q_b = s_as_b + x_ax_bi + y_ay_bj + z_az_bk
$$

### <font color="YellowGreen">用四元数表示旋转</font>

首先，把一个三维空间点用一个虚四元数来描述
$$
p = [0, x, y, z] = [0, v]
$$

这相当于把四元数的三个虚部和空间的三个轴相对应，用四元数表示这个旋转

$$
q = [cos {\frac \theta 2}, n sin{\frac \theta 2}]
$$

那么旋转后的点 $p^,$ 即可表示为这样的乘积

$$
p^, = qpq^{-1}
$$

## 相似 仿射 射影变换

### 相似变换

$$
T_s = \begin{bmatrix}
sR & t \\
0^T & 1
\end{bmatrix}
$$

相比于正常的变换，多了一个缩放因子 s

### 仿射变换

$$
T_A = \begin{bmatrix}
A & t \\
0^T & 1
\end{bmatrix}
$$

仿射变换只要求A是一个可逆矩阵，不必是正交矩阵，经过仿射变换后，立方体就不再是方的了，

### 射影变换

$$
T_P = \begin{bmatrix}
A & t \\
a^T & v
\end{bmatrix}
$$

即左上角是可逆矩阵，右上角是平移t，左下角为缩放 $a^T$

可以想象原本的一个方形的地板砖，在相机上的投影变成了一个不规则的四边形

## 总结

本讲介绍了四种三维空间下刚体运动的描述方式

+ 旋转矩阵 $R_{3 \times 3}$, 他是一个行列式为1的正交阵，它的逆就是他的转置
+ 变换矩阵就是旋转和平移的拼接
  $$
  T = \begin{bmatrix}
  R & t \\
  0^T & 1
  \end{bmatrix}
  $$
+ 旋转向量 就是旋转前后两个向量的叉乘，方向由右手定则给出，大小描绘旋转度的大小
+ 四元数：用四个数表示某个旋转，若某个旋转时以单位向量n=[a, b, c]为轴旋转了 $\theta$,那么四元数可以表示为

$$
q = [cos \frac \theta 2, asin \frac \theta 2, bsin \frac \theta 2, csin \frac \theta 2]^T
$$
