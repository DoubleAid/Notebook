    # 棋盘格计算相机内参

## 参考文档

[棋盘格生成器](https://calib.io/zh/pages/camera-calibration-pattern-generator)
[参考文档](https://zhuanlan.zhihu.com/p/638774229)

## 原理讲解

### 坐标系之间的转换

首先先进行设定

1. 坐标系 $(X_w, Y_w, Z_w)$ 为世界(world)坐标系
2. 坐标系 $(X_c, Y_c, Z_c)$ 为相机(camera)坐标系
3. 坐标系 (x, y) 为图像坐标系, 以图像中心为原点
4. 坐标系 (u, v) 为像素坐标系，以图像左上角为原点

#### 像素坐标系 和 图像坐标系的转换

注意像素坐标系(u, v)的单位是像素，但是(x, y)是归一化的图像坐标系，具体坐标值都是一个比例因子，具体单位是毫米还是m，是由深度相机得到或者估算的深度值 ${Z_c}$ 来决定

设相机内参
$$
K = \begin{bmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1
\end{bmatrix} \\
$$

那么图像坐标系转向像素坐标系：

$$
\begin{bmatrix}
u \\
v \\
1
\end{bmatrix} = K * \begin{bmatrix}
x \\
y \\
1
\end{bmatrix}
$$

由像素坐标系转向图像坐标系

$$
\begin{bmatrix}
x \\
y \\
1
\end{bmatrix} = K^{-1} * \begin{bmatrix}
u \\
v \\
1
\end{bmatrix}
$$

得到的 (x, y, 1) 是包含畸变效果的畸变图像坐标系下的位置，可以通过相机标定得到的畸变参数可以去畸变校准图像

#### 图像坐标系 和 相机坐标系的转换

设深度值为 $Z_c$, 这里 $Z_c$ 是标量， 运算是数乘向量

那么由图像坐标系转向相机坐标系:

$$
\begin{bmatrix}
X_c \\
Y_c \\
Z_c
\end{bmatrix} = Z_c * \begin{bmatrix}
x \\
y \\
1
\end{bmatrix}
$$

那么由相机坐标系转向图像坐标系:

$$
\begin{bmatrix}
x \\
y \\
1
\end{bmatrix} = \begin{bmatrix}
X_c \\
Y_c \\
Z_c
\end{bmatrix} / Z_c
$$

相机坐标系 与 世界坐标系的转换

R 为世界坐标系到相机坐标系的旋转矩阵，t 为世界坐标系到相机坐标系的平移向量

那么由世界坐标系到相机坐标系的转换:

$$
\begin{bmatrix}
X_c \\
Y_c \\
Z_c
\end{bmatrix} = R\begin{bmatrix}
X_w \\
Y_w \\
Z_w
\end{bmatrix} + t
$$

那么由相机坐标系转到世界坐标系为

$$
\begin{bmatrix}
X_w \\
Y_w \\
Z_w
\end{bmatrix} = R^{-1} (\begin{bmatrix}
X_c \\
Y_c \\
Z_c
\end{bmatrix} - t)
$$

下面这个图可以很好的说明坐标系之间的关系

![坐标关系](/5_自动驾驶/images/坐标转换关系.png)

联立这些转换，可以得到转换的公式

$$
\begin{bmatrix}
u \\
v \\
1
\end{bmatrix} = \frac 1 {Z_c} \begin{bmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1
\end{bmatrix}[R | t] \begin{bmatrix}
X_w \\
Y_w \\
Z_w \\
1
\end{bmatrix}
$$

当我们使用棋盘格进行标定时，
1. 我们从不同方位拍摄棋盘格，$\begin{bmatrix}
X_w \\
Y_w \\
Z_w \\
1
\end{bmatrix}$ 是一个固定值，$\begin{bmatrix}
u \\
v \\
1
\end{bmatrix}$ 是一个图像上坐标，是一个已知值

## 张正友标定法

### 单应性，单应矩阵，齐次坐标

单应性：平面的单应性被定义为从一个平面到另一个平面的投影映射，这个投影转换称为单应性变换或者投影变换

### 公式推导

#### 1. 平面假设简化

因为棋盘格是在一个平面上，我们假设世界坐标系以这个平面为基准，且 $Z_w = 0$, 那么投影方程就可以简化成

$$
s \begin{bmatrix}
u \\
v \\
1
\end{bmatrix} = K \begin{bmatrix} r1 & r2 & r3 & t \end{bmatrix} \begin{bmatrix}
X_w \\
Y_w \\
0 \\
1
\end{bmatrix} = K \begin{bmatrix} r1 & r2 & t \end{bmatrix} \begin{bmatrix}
X_w \\
Y_w \\
1
\end{bmatrix}
$$

令 $H = K \begin{bmatrix} r1 & r2 & t \end{bmatrix}$, 这个就是单应矩阵，我们可以假设

$$
H = \begin{bmatrix} h_1 & h_2 & h_3 \end{bmatrix} = K \begin{bmatrix} r_1 & r_2 & t \end{bmatrix}
$$

#### 2. 从单应矩阵约束内参

因为 $r_1$ 和 $r_2$ 是正交单位向量

+ $r_1^Tr_2 = 0$ 正交性
+ $||r_1|| = ||r_2|| = 1$ 单位长度 ==> $AA^T = 1$

从 $h_1 = Kr_1$ 和 $h2 = Kr_2$ 可以得到:

$$
r1 = K^{-1}h_1, r2 = K^{-1}h_2
$$

约束1：正交性 $r_1^Tr_2 = 0$ ==>

$$
h^T_1K^{-T}K^{-1}h_2 = 0
$$

约束2：单位长度 $$||r_1|| = ||r_2||$$ ==> $r_1r_1^T = r_2r_2^T$

$$
h_1^TK^{-T}K^{-1}h_1 = h_2^TK^{-T}K^{-1}h_2
$$

#### 3. 核心矩阵 $B = K^{-T}K^{-1}$

因为 $B^T = B$, 所以B是一个对称矩阵，因此可以假设:

$$
B = \begin{bmatrix}
b_11 & b_12 & b_13 \\
b_12 & b_22 & b_23 \\
b_13 & b_23 & b_33
\end{bmatrix}
$$

所以上面的约束就变成了

$$
h_1^TBh_2 = 0
$$

$$
h_1^TBh_1 = h2^TBh_2
$$

#### 4. 计算步骤

+ 步骤一: 因为在棋盘格上，是有对应的坐标的，所以可以根据多个特征点的联立计算单应矩阵
+ 步骤二: 根据计算出的单应矩阵，建立两个约束的方程，求解B
+ 步骤三: 从B里分离内参矩阵K
