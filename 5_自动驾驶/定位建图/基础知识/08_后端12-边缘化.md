# 边缘化

在滑动窗口优化中，当窗口移动时，旧的变量（如较早的机器人位姿）需要被移除，但它们的约束信息（如里程计和观测）仍需保留，以避免信息丢失。​​边缘化​​通过数学方法将旧变量的影响转移到剩余变量上，保持优化问题的稀疏性和计算效率。

以上一章的例子为例，我们继续讨论边缘化的过程。

## 二维滑动窗口问题描述

机器人在二维平面上移动，窗口大小为5，保留最近的5个位姿 (比如 y4, y5, y6, y7, y8)
当机器人到达y9时，需要移除最旧的位姿 y4， 同时保留 y4 对后续位姿的约束信息

## 边缘化过程

### 构建和边缘化变量相关的约束

+ y4 与 y5 之间有里程计约束（回环约束）；
+ y4 和 y5 之间有相同的观测点 (重投影误差)

这些约束的联合优化问题可以表示为

$$
\min_{y_4, y_5}(||e_{位姿}(y_4, y_5)||^2 + ||e_{观测}(y_4, y_5)||^2)
$$

我们设 位姿信息为x，观测信息为 z，将上面的残差函数简化为 f(x, z).

根据高斯牛顿法，我们想要计算这个有点复杂的最小二乘问题，就先进行二阶泰勒展开

$$
f(t) \approx f(t)|_{t=0} + Jt - \frac 1 2 Ht^2
$$

在这个最小二乘问题 $f(t)|_{t=0}$ 就变成了一个固定值，不会随着最小二乘的t变化而改变，问题就变成了求剩下部分的最小值了

那么计算就变成了

$$
[y_4, y_5]\begin{bmatrix}
H_{44} & H_{45} \\
H_{54} & H_{55}
\end{bmatrix}\begin{bmatrix}
y_4 \\
y_5
\end{bmatrix} -2\begin{bmatrix}
b_4 & b_5
\end{bmatrix}\begin{bmatrix}
y_4 \\
y_5
\end{bmatrix}
$$

我们想要消除掉 y4 这个变量，接下来介绍一下如何消除掉一个变量

## 使用 舒尔补 Schur 补将一个元消除掉

对于一个海森矩阵 $\begin{bmatrix}
A & E \\
E^T & B
\end{bmatrix}
$ 还有一个 雅可比矩阵 $\begin{bmatrix}
b_{1} \\
b_{2}
\end{bmatrix}
$

矩阵的舒尔补有两种形式

$$
H_{marg} = B - E^T A^{-1} E \\
J_{marg} = b_2 - E^T A^{-1} b_1
$$

按照这样写就变成了

$$
H_{marg} = H_{55} - H{54}H_{44}^{-1}H_{45} \\
b_{marg} = b_5 - H{54}H_{44}^{-1}b_4
$$

结果问题就变成了

$$
min(y_5^TH_{marg}y_5 - 2b_{marg}^Ty_5)
$$

这样就省略了 y4 的参数的输入
