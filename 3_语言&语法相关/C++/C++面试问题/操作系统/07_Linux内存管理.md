# Linux 内存管理

## 内存管理机制

### 虚拟内存管理：

- 分页机制：将物理内存划分为固定大小的页（通常4KB），通过页表（Page Table）实现虚拟地址到物理地址的映射。
- 多级页表：x86-64架构使用4级页表（PGD→PUD→PMD→PTE），减少内存占用。
- 内存区域划分：用户空间（进程私有）和内核空间（所有进程共享）。

#### 页表的作用

页表的主要作用是将虚拟地址映射到物理地址。每个页表项通常包含以下信息：

- 物理页框号（PFN）：映射到的物理内存块的地址。
- 存在位（Present Bit）：表示该虚拟页是否在物理内存中。
- 访问位（Accessed Bit）：记录该虚拟页是否被访问过。
- 脏位（Dirty Bit）：记录该虚拟页是否被修改过。
- 保护位（Protection Bits）：定义对该虚拟页的访问权限（如只读、可读写、可执行）。
- 其他信息：如引用位、页面大小等。

#### 数据访问步骤

在32位系统中，如果页的大小是4KB，那么虚拟地址可以被分为两部分：虚拟页号（Virtual Page Number, VPN）和页内偏移（Offset）。

##### 虚拟地址的组成

- 虚拟页号（VPN）：占20位，用于索引页表，找到对应的物理页框号（Physical Frame Number, PFN）。
- 页内偏移（Offset）：占12位，用于在物理页内找到具体的数据位置。

##### 虚拟地址到物理地址的转换

当进程访问一个虚拟地址时，操作系统会通过以下步骤将其转换为物理地址：

- 计算虚拟页号：从虚拟地址中提取高20位作为虚拟页号。
- 查找页表：
  - 使用虚拟页号在页表中查找对应的页表项。
  - 如果存在位为0，表示该虚拟页不在物理内存中，可能需要触发页面置换。
- 获取物理页框号：如果存在位为1，从页表项中获取物理页框号。
- 计算物理地址：将物理页框号与页内偏移组合，得到最终的物理地址。

### 物理内存管理：

- 伙伴系统（Buddy System）：管理物理页的分配与回收，解决外部碎片问题（如分配连续物理页）。
- Slab分配器：基于伙伴系统，管理小对象（如task_struct）的缓存，减少内存碎片。
- 内存回收：
  - kswapd守护进程：定期扫描并回收不活跃内存页。
  - LRU算法：优先回收最近最少使用的页面。
  - OOM Killer：在内存耗尽时终止占用内存最多的进程。

#### 伙伴系统

伙伴系统是一种高效的内存分配和管理算法，主要用于Linux中的外部碎片问题。它通过将内存块划分为大小为2的幂次的块，并根据需求动态分配和合并内存块，从而减少内存碎片和分配开销。

##### 主要思想

- 内存块划分：伙伴系统将所有空闲页框分组为不同大小的链表，每一块链表分别包含大小为1、2、4、8、16、32、64、128、256、512和1024个连续的页框。
- 分配内存：当需要分配内存时，系统会寻找最小的足够大的内存块。如果没有精确匹配的块存在，则找到更大的块并将其分裂成两个伙伴块，直到得到合适大小的块。
- 释放内存：当释放内存时，系统会检查它的伙伴块是否也空闲。如果空闲，则将两个伙伴块合并成一个更大的块。这个过程递归进行，直到无法再合并为止。

##### 优点

- 减少外部碎片：通过将内存块划分为固定大小的块，可以有效减少外部碎片。
- 高效管理：伙伴系统使用自由链表数组来管理不同大小的块，查找和分配内存块的速度较快。

##### 缺点

- 内部碎片：每次分配必须是2的幂次个页，如果需要的内存大小不是2的幂次，会造成内部碎片。
- 释放复杂性：释放内存时，调用方必须记住之前该内存块分配的大小，这对于调用者来说可能不方便。

### Swap机制：

- 将不活跃的内存页换出到磁盘交换分区，腾出物理内存空间。
- 通过swappiness参数（默认60）控制换出积极性。

## 关键优化技术

- 透明大页（THP）：合并2MB或1GB的大页，减少TLB Miss。
- 内存压缩（Zswap）：将待换出的页压缩后存储在内存中，降低磁盘I/O。
- NUMA优化：针对多核CPU的本地内存优先分配策略。
